<!DOCTYPE html>
<!--
================================================================================
CHRONOSTAR - DEVELOPMENT NOTES & CHANGE LOG
================================================================================

CHANGE LOG:
-----------
v2.3 (This update):
1. Reorganized layout: Youth Indicators panel now sits directly below Target Star panel
2. Cleaned up CSS and removed redundant styles

v2.2 (Previous):
1. resolveIdentifier() now selects the *closest* SIMBAD match (best Gaia‚ÜîSIMBAD positional agreement)
2. Comoving kinematics now use *convergent-point / shared space-velocity projection*
   - Velocity offset uses projected tangential-velocity residuals (accounts for sky-position projection)
   - Predicted RV uses the shared 3D velocity vector (if target RV exists)
3. No RV cut is imposed for comoving selection (binary RVs can be offset)

v2.1 (Previous):
1. CMD isochrones now use REAL PARSEC data (100 Myr and 1 Gyr, [M/H]=0)
2. Removed x=0 and y=0 zeroline emphasis in CMD plot
3. Default search radius changed from 10 pc to 5 pc
4. "Advanced Options" redesigned as clearer dropdown with arrow indicator
5. Galactic coordinate plot uses Gaia DR3 MW edge-on image as background

DATA SOURCES:
-------------
- PARSEC isochrones: http://stev.oapd.inaf.it/cmd
- Gaia DR3: VizieR I/355/gaiadr3 (and I/355/paramp for Teff/logg)
- SIMBAD TAP: https://simbad.cds.unistra.fr/simbad/sim-tap
- Youth indicators: Various VizieR catalogs
- FriendFinder concept: Tofflemire et al. (2021)

================================================================================
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChronoStar - Stellar Age Analysis</title>
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script
      type="text/javascript"
      src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js"
      charset="utf-8"
    ></script>

    <style>
      :root {
        --bg-primary: #0a0e17;
        --bg-secondary: #111827;
        --bg-tertiary: #1f2937;
        --text-primary: #f0f4f8;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;
        --accent-blue: #3b82f6;
        --accent-cyan: #22d3ee;
        --accent-purple: #a78bfa;
        --accent-orange: #fb923c;
        --accent-green: #4ade80;
        --accent-red: #f87171;
        --border-color: #374151;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "IBM Plex Sans", -apple-system, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(1px 1px at 20px 30px, rgba(255, 255, 255, 0.8), transparent),
          radial-gradient(1px 1px at 40px 70px, rgba(255, 255, 255, 0.5), transparent),
          radial-gradient(1px 1px at 50px 160px, rgba(255, 255, 255, 0.6), transparent),
          radial-gradient(1px 1px at 90px 40px, rgba(255, 255, 255, 0.4), transparent),
          radial-gradient(1px 1px at 130px 80px, rgba(255, 255, 255, 0.7), transparent),
          radial-gradient(1.5px 1.5px at 160px 120px, rgba(34, 211, 238, 0.9), transparent),
          radial-gradient(1px 1px at 200px 50px, rgba(255, 255, 255, 0.5), transparent),
          radial-gradient(1px 1px at 250px 180px, rgba(255, 255, 255, 0.6), transparent),
          radial-gradient(1px 1px at 300px 90px, rgba(255, 255, 255, 0.4), transparent),
          radial-gradient(1.5px 1.5px at 350px 140px, rgba(167, 139, 250, 0.8), transparent);
        background-size: 400px 200px;
        pointer-events: none;
        z-index: -1;
        opacity: 0.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding: 1.25rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      h1 {
        font-size: 2.2rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        margin-bottom: 0.1rem;
        background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        color: var(--text-secondary);
        font-size: 1rem;
        font-weight: 300;
      }

      .subtitle a,
      .header-attribution a {
        color: var(--accent-cyan);
        text-decoration: none;
      }

      .search-section {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 0.7rem 1rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
      }

      .input-group {
        display: flex;
        gap: 0.7rem;
        flex-wrap: wrap;
        align-items: flex-end;
      }

      .input-field {
        flex: 1;
        min-width: 380px;
      }

      .input-field label {
        display: block;
        font-size: 0.7rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.35rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .input-field input,
      .input-field select {
        width: 100%;
        padding: 0.65rem 0.85rem;
        font-size: 0.95rem;
        font-family: "IBM Plex Mono", monospace;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        transition: all 0.2s ease;
      }

      .input-field input:focus,
      .input-field select:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.15);
      }

      .input-field input::placeholder {
        color: var(--text-muted);
      }

      .btn {
        padding: 0.65rem 1.5rem;
        font-size: 0.95rem;
        font-weight: 500;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover:not(:disabled) {
        background: var(--border-color);
      }

      .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
      }

      .status-bar {
        margin-top: 1rem;
        padding: 0.7rem;
        background: var(--bg-tertiary);
        border-radius: 6px;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.8rem;
        display: none;
      }

      .status-bar.visible {
        display: block;
      }

      .status-bar .status-text {
        color: var(--accent-cyan);
      }

      .status-bar.error .status-text {
        color: var(--error);
      }

      .status-bar.success .status-text {
        color: var(--success);
      }

      .results-section {
        display: none;
      }

      .results-section.visible {
        display: block;
      }

      /* Main two-column grid */
      .results-grid {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: start;
      }

      .left-column {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .right-column {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 420px;
      }

      @media (max-width: 1000px) {
        .results-grid {
          grid-template-columns: 1fr;
        }

        .right-column {
          width: 100%;
        }
      }

      .panel {
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
      }

      .panel-header {
        padding: 0.7rem 1rem;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .panel-title {
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .panel-title .icon {
        width: 18px;
        height: 18px;
        opacity: 0.8;
      }

      .panel-body {
        padding: 0.7rem;
      }

      .panel-body.collapsed {
        display: none;
      }

      .collapse-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        transition: transform 0.3s ease;
      }

      .collapse-btn:hover {
        color: var(--text-primary);
      }

      .collapse-btn.collapsed {
        transform: rotate(-90deg);
      }

      .target-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
      }

      .info-item {
        padding: 0.5rem 0.7rem;
        background: var(--bg-tertiary);
        border-radius: 6px;
      }

      .info-item .label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.15rem;
      }

      .info-item .value {
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.9rem;
        color: var(--text-primary);
      }

      .info-item .value.highlight {
        color: var(--accent-cyan);
      }

      .plot-container {
        width: 100%;
        height: 500px;
        background: var(--bg-primary);
        border-radius: 8px;
      }

      .cmd-plot-container {
        width: 100%;
        max-width: 420px;
        height: 600px;
        margin: 0 auto;
      }

      .galactic-plot-container {
        width: 100%;
        height: 265px;
      }

      .toomre-plot-container {
        width: 100%;
        height: 320px;
      }

      .gyro-plot-container {
        max-width: 800px;
        height: 450px;
        margin: 0 auto;
      }

      .data-table-wrapper {
        max-height: 400px;
        overflow: auto;
        border-radius: 8px;
        border: 1px solid var(--border-color);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .data-table th {
        position: sticky;
        top: 0;
        background: var(--bg-tertiary);
        padding: 0.7rem 1rem;
        text-align: left;
        font-weight: 500;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
      }

      .data-table td {
        padding: 0.625rem 1rem;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
      }

      .data-table tr:hover td {
        background: var(--bg-tertiary);
      }

      .data-table .target-row {
        background: rgba(34, 211, 238, 0.1);
      }

      .badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        font-size: 0.7rem;
        border-radius: 4px;
        font-weight: 500;
      }

      .badge-info {
        background: rgba(59, 130, 246, 0.2);
        color: var(--accent-blue);
      }

      .full-width-panel {
        grid-column: 1 / -1;
      }

      #aladin-lite-div {
        width: 100%;
        height: 350px;
        min-height: 350px;
        max-height: 350px;
        border-radius: 8px;
        overflow: hidden;
      }

      .youth-indicators-grid {
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
      }

      .youth-indicator-panel {
        padding: 0.7rem;
        border-radius: 8px;
        border-left: 3px solid;
      }

      .youth-indicator-panel.li-panel {
        background: rgba(251, 146, 60, 0.1);
        border-left-color: var(--accent-orange);
      }

      .youth-indicator-panel.prot-panel {
        background: rgba(34, 197, 94, 0.1);
        border-left-color: var(--accent-green);
      }

      .youth-indicator-panel.rhk-panel {
        background: rgba(168, 85, 247, 0.1);
        border-left-color: var(--accent-purple);
      }

      .youth-indicator-panel.lx-panel {
        background: rgba(34, 211, 238, 0.1);
        border-left-color: var(--accent-cyan);
      }

      .youth-indicator-panel h4 {
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
      }

      .youth-indicator-panel.li-panel h4 {
        color: var(--accent-orange);
      }

      .youth-indicator-panel.prot-panel h4 {
        color: var(--accent-green);
      }

      .youth-indicator-panel.rhk-panel h4 {
        color: var(--accent-purple);
      }

      .youth-indicator-panel.lx-panel h4 {
        color: var(--accent-cyan);
      }

      .youth-indicator-values {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .youth-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.7rem;
        background: var(--bg-tertiary);
        border-radius: 6px;
        font-size: 0.85rem;
      }

      .youth-item .value {
        font-family: "IBM Plex Mono", monospace;
        font-weight: 500;
      }

      .youth-item .value.li-color {
        color: var(--accent-orange);
      }

      .youth-item .value.prot-color {
        color: var(--accent-green);
      }

      .youth-item .value.rhk-color {
        color: var(--accent-purple);
      }

      .youth-item .value.lx-color {
        color: var(--accent-cyan);
      }

      .youth-item .source {
        font-size: 0.7rem;
        color: var(--text-muted);
        max-width: 130px;
        text-align: right;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .youth-item a.source {
        color: var(--accent-cyan);
        text-decoration: none;
      }

      .youth-item a.source:hover {
        color: var(--text-primary);
        text-decoration: underline;
      }

      .no-data {
        color: var(--text-muted);
        font-style: italic;
        padding: 0.5rem;
        text-align: center;
      }

      .walking-loader {
        position: relative;
        height: 28px;
        margin-bottom: 0.25rem;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .walking-loader.active {
        opacity: 1;
      }

      .walking-emoji {
        position: absolute;
        font-size: 1.4rem;
        top: 50%;
        transform: translateY(-50%);
        animation: flyAcross 25s linear infinite;
      }

      .walking-emoji::after {
        content: "¬∑ ¬∑ ‚ú¶";
        position: absolute;
        right: 100%;
        bottom: -2px;
        margin-right: 2px;
        font-size: 0.7rem;
        opacity: 0.5;
        animation: trailFade 25s linear infinite;
        white-space: nowrap;
        letter-spacing: 3px;
        color: var(--accent-cyan);
      }

      @keyframes flyAcross {
        0% {
          left: -8%;
          transform: translateY(-50%) scaleX(1);
        }
        48% {
          left: 100%;
          transform: translateY(-50%) scaleX(1);
        }
        50% {
          left: 100%;
          transform: translateY(-50%) scaleX(-1);
        }
        98% {
          left: -8%;
          transform: translateY(-50%) scaleX(-1);
        }
        100% {
          left: -8%;
          transform: translateY(-50%) scaleX(1);
        }
      }

      @keyframes trailFade {
        0%,
        48% {
          opacity: 0.4;
        }
        49%,
        51% {
          opacity: 0;
        }
        52%,
        98% {
          opacity: 0.4;
        }
        99%,
        100% {
          opacity: 0;
        }
      }

      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .progress-steps {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.7rem;
      }

      .progress-step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
      }

      .progress-step .check {
        color: var(--success);
      }

      .progress-step .pending {
        color: var(--text-muted);
      }

      .progress-step .active {
        color: var(--accent-cyan);
      }

      .advanced-toggle {
        margin: 0;
        padding: 0.35rem 0.6rem;
        font-size: 0.7rem;
        font-weight: 500;
        font-family: "IBM Plex Sans", -apple-system, sans-serif;
        background: rgba(167, 139, 250, 0.15);
        border: 1px solid rgba(167, 139, 250, 0.4);
        border-radius: 4px;
        color: var(--accent-purple);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        transition: all 0.2s ease;
        line-height: 1;
        box-sizing: border-box;
        height: auto;
      }

      .advanced-toggle:hover {
        background: rgba(167, 139, 250, 0.25);
        border-color: var(--accent-purple);
      }

      .advanced-toggle.expanded {
        background: rgba(167, 139, 250, 0.25);
        border-color: var(--accent-purple);
      }

      .advanced-toggle .toggle-arrow {
        transition: transform 0.3s ease;
      }

      .advanced-toggle.expanded .toggle-arrow {
        transform: rotate(180deg);
      }

      .advanced-options {
        display: none;
        margin-top: 1rem;
        padding: 1rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }

      .advanced-options.visible {
        display: block;
      }

      .small-inputs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
      }

      .small-inputs .input-field {
        min-width: auto;
      }

      .aladin-fov-info {
        margin-top: 0.7rem;
        padding: 0.5rem 0.7rem;
        background: var(--bg-tertiary);
        border-radius: 6px;
        font-size: 0.8rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .aladin-fov-info .fov-value {
        color: var(--accent-cyan);
        font-family: "IBM Plex Mono", monospace;
      }

      .external-links {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 0.7rem;
        margin-bottom: 0.5rem;
      }

      .external-link {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.6rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.7rem;
        transition: all 0.2s ease;
      }

      .external-link:hover {
        background: var(--border-color);
        border-color: var(--accent-cyan);
        color: var(--text-primary);
      }

      .external-link svg {
        width: 12px;
        height: 12px;
        opacity: 0.7;
      }

      footer {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
        font-size: 0.85rem;
        border-top: 1px solid var(--border-color);
        margin-top: 3rem;
      }

      footer a {
        color: var(--accent-cyan);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-color);
      }

      .action-buttons .btn-small {
        padding: 0.35rem 0.6rem;
        font-size: 0.7rem;
        gap: 0.3rem;
        border-radius: 4px;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: var(--accent-blue);
      }

      .action-buttons .btn-small:hover:not(:disabled) {
        background: rgba(59, 130, 246, 0.25);
        border-color: var(--accent-blue);
      }

      .action-buttons .btn-small#btn-comoving {
        background: rgba(167, 139, 250, 0.15);
        border: 1px solid rgba(167, 139, 250, 0.4);
        color: var(--accent-purple);
      }

      .action-buttons .btn-small#btn-comoving:hover:not(:disabled) {
        background: rgba(167, 139, 250, 0.25);
        border-color: var(--accent-purple);
      }

      .exoplanet-alert {
        background: rgba(251, 191, 36, 0.15);
        border: 1px solid var(--accent-orange);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 0.7rem;
      }

      .exoplanet-alert-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        color: var(--accent-orange);
        font-weight: 600;
      }

      .tess-info {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid var(--accent-blue);
        border-radius: 6px;
        padding: 0.7rem;
        margin-top: 0.5rem;
      }

      .tess-info-header {
        color: var(--accent-blue);
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <h1>ChronoStar</h1>
        <p class="subtitle">Stellar age analysis via youth indicators, kinematics, & CMD position</p>
      </header>

      <!-- Search Section -->
      <section class="search-section">
        <div class="walking-loader" id="walking-loader">
          <span class="walking-emoji">üõ∞Ô∏è</span>
        </div>

        <div class="input-group">
          <div class="input-field">
            <label for="target-id">Target (Gaia DR3 ID or SIMBAD Name)</label>
            <input
              type="text"
              id="target-id"
              placeholder="e.g., 2007420940415412352, TOI 811, HD 63433, TOI-5882"
            />
          </div>
          <button class="btn btn-primary" id="search-btn" onclick="runSearch()">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            Search
          </button>
        </div>

        <div class="status-bar" id="status-bar">
          <span class="status-text" id="status-text"></span>
          <div class="progress-steps" id="progress-steps"></div>
        </div>
      </section>

      <!-- Results Section -->
      <section class="results-section" id="results-section">
        <!-- Main Grid: Left Column | Right Column -->
        <div class="results-grid">
          <!-- LEFT COLUMN: Target Star, Youth Indicators, Gyro -->
          <div class="left-column">
            <!-- Target Star Panel -->
            <div class="panel">
              <div class="panel-header">
                <span class="panel-title">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  Target Star
                </span>
              </div>
              <div class="panel-body">
                <div class="target-info" id="target-info"></div>
                <div class="external-links" id="external-links"></div>

                <div class="action-buttons" id="action-buttons">
                  <button class="btn btn-secondary btn-small" id="btn-tess" onclick="searchTESSSectors()">
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 6v6l4 2"></path>
                    </svg>
                    TESS Sectors
                  </button>
                  <button
                    class="btn btn-secondary btn-small"
                    id="btn-exoplanet"
                    onclick="checkExoplanetArchive()"
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="10"></circle>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Check Exoplanets
                  </button>
                  <button
                    class="btn btn-secondary btn-small"
                    id="btn-youth"
                    onclick="searchYouthIndicators()"
                    style="background: rgba(74, 222, 128, 0.15); border-color: rgba(74, 222, 128, 0.4); color: var(--accent-green);"
                    >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M12 2v20M2 12h20"></path>
                    </svg>
                    Youth Indicators
                  </button>
                  <button
                    class="btn btn-secondary btn-small"
                    id="btn-comoving"
                    onclick="runComovingSearch()"
                    style="background: rgba(167, 139, 250, 0.15); border-color: rgba(167, 139, 250, 0.4); color: var(--accent-purple);"
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="3"></circle>
                      <circle cx="4" cy="4" r="2"></circle>
                      <circle cx="20" cy="4" r="2"></circle>
                      <circle cx="4" cy="20" r="2"></circle>
                      <circle cx="20" cy="20" r="2"></circle>
                    </svg>
                    Comoving Search
                  </button>
                  <div class="advanced-toggle" id="advanced-toggle" onclick="toggleAdvanced()">
                    <svg
                      class="toggle-arrow"
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    Comoving Search Options
                  </div>
                </div>

                <div class="advanced-options" id="advanced-options">
                  <div class="small-inputs">
                    <div class="input-field">
                      <label for="velocity-limit">Velocity Limit (km/s)</label>
                      <input type="number" id="velocity-limit" value="5.0" step="0.5" />
                    </div>
                    <div class="input-field">
                      <label for="search-radius">Search Radius (pc)</label>
                      <input type="number" id="search-radius" value="5" step="5" />
                    </div>
                  </div>
                  <div style="margin-top: 0.7rem; font-size: 0.7rem; color: var(--text-muted)">
                    Note: no RV cut is applied (binary RVs can be offset). Results are shown at the bottom of the page.
                  </div>
                </div>

                <div id="tess-info-container"></div>
                <div id="exoplanet-alert"></div>
              </div>
            </div>

            <!-- Youth Indicators Panel -->
            <div class="panel">
              <div class="panel-header">
                <span class="panel-title">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M2 12h20"></path>
                  </svg>
                  Youth Indicators
                </span>
              </div>
              <div class="panel-body">
                <div class="youth-indicators-grid" id="youth-indicators-grid">
                  <div class="youth-indicator-panel li-panel">
                    <h4>EW(Li) and A(Li) - Lithium</h4>
                    <div class="youth-indicator-values" id="li-values">
                      <div class="no-data">Click "Youth Indicators" above to search</div>
                    </div>
                  </div>
                  <div class="youth-indicator-panel prot-panel">
                    <h4>P<sub>rot</sub> - Rotation</h4>
                    <div class="youth-indicator-values" id="rotation-results">
                      <div class="no-data">Click "Youth Indicators" above to search</div>
                    </div>
                  </div>
                  <div class="youth-indicator-panel rhk-panel">
                    <h4>log(R'<sub>HK</sub>) - Activity</h4>
                    <div class="youth-indicator-values" id="rhk-results">
                      <div class="no-data">Click "Youth Indicators" above to search</div>
                    </div>
                  </div>
                  <div class="youth-indicator-panel lx-panel">
                    <h4>log(L<sub>X</sub>) - X-ray</h4>
                    <div class="youth-indicator-values" id="lx-results">
                      <div class="no-data">Click "Youth Indicators" above to search</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Gyrochronology Panel -->
            <div class="panel" id="gyro-panel" style="display: none">
              <div class="panel-header">
                <span class="panel-title">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  Gyrochronology: P<sub>rot</sub> vs T<sub>eff</sub>
                </span>
                <button class="btn btn-secondary btn-small" onclick="downloadGyroPlot()">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  PNG
                </button>
              </div>
              <div class="panel-body">
                <div class="gyro-plot-container" id="gyro-plot"></div>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN: Sky View, Galactic Position -->
          <div class="right-column">
            <!-- Sky View Panel -->
            <div class="panel" id="sky-view-panel">
              <div class="panel-header">
                <span class="panel-title">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                  </svg>
                  Sky View
                </span>
                <button class="collapse-btn" onclick="togglePanel('sky-view-panel')" title="Toggle panel">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
              </div>
              <div class="panel-body">
                <div id="aladin-lite-div"></div>
                <div class="aladin-fov-info" id="aladin-fov-info">
                  Field of view: <span class="fov-value" id="fov-value">--</span>
                </div>
              </div>
            </div>

            <!-- Galactic Position Panel -->
            <div class="panel" id="galactic-panel">
              <div class="panel-header">
                <span class="panel-title">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="12" rx="10" ry="4"></ellipse>
                    <path d="M12 2v20"></path>
                  </svg>
                  Galactic Position
                </span>
                <button class="btn btn-secondary btn-small" onclick="downloadGalacticPlot()">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  PNG
                </button>
              </div>
              <div class="panel-body">
                <div class="galactic-plot-container" id="galactic-plot"></div>
              </div>
            </div>

            <div class="panel" id="toomre-panel" style="display: none">
              <div class="panel-header">
                <span class="panel-title">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                  </svg>
                  Toomre Diagram
                </span>
                <button class="btn btn-secondary btn-small" onclick="downloadToomrePlot()">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  PNG
                </button>
              </div>
              <div class="panel-body">
                <div class="toomre-plot-container" id="toomre-plot"></div>
              </div>
            </div>

            <!-- CMD Panel -->
            <div class="panel">
              <div class="panel-header">
                <span class="panel-title">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"></path>
                    <circle cx="9" cy="9" r="2"></circle>
                    <circle cx="19" cy="5" r="2"></circle>
                    <circle cx="14" cy="14" r="2"></circle>
                  </svg>
                  CMD
                </span>
                <button class="btn btn-secondary btn-small" onclick="downloadPlot()">
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  PNG
                </button>
              </div>
              <div class="panel-body">
                <div class="cmd-plot-container" id="cmd-plot"></div>
              </div>
            </div>
          </div>
          <!-- END RIGHT COLUMN -->
        </div>
        <!-- END results-grid -->

        <!-- Comoving Candidates Panel (Full Width) -->
        <div class="panel full-width-panel" id="comoving-panel" style="display: none">
          <div class="panel-header">
            <span class="panel-title">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                <path d="M3 9h18M9 21V9"></path>
              </svg>
              Comoving Candidates
              <span class="badge badge-info" id="candidate-count">0 stars</span>
            </span>
            <button class="btn btn-secondary btn-small" onclick="downloadCSV()">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              CSV
            </button>
          </div>
          <div class="panel-body">
            <div class="data-table-wrapper">
              <table class="data-table" id="results-table">
                <thead>
                  <tr>
                    <th>Index</th>
                    <th>Gaia DR3 ID</th>
                    <th>RA</th>
                    <th>Dec</th>
                    <th>G mag</th>
                    <th>Bp-Rp</th>
                    <th>V<sub>off</sub> (km/s)</th>
                    <th>Sep (¬∞)</th>
                    <th>Sep 3D (pc)</th>
                    <th>RV<sub>pred</sub></th>
                    <th>RV<sub>obs</sub></th>
                    <th>SpT</th>
                    <th>RUWE</th>
                  </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <!-- END results-section -->

      <footer>
        <p>
          Made for the <a href="https://msoaresfurtado.com" target="_blank">Soares-Furtado Research Group</a>,
          UW-Madison
        </p>
        <p style="margin-top: 0.5rem">
          Comoving search inspired by <a href="https://github.com/adamkraus/Comove" target="_blank">FriendFinder</a>
          | Please cite:
          <a href="https://ui.adsabs.harvard.edu/abs/2021AJ....161..171T" target="_blank">Tofflemire et al. (2021)</a>
        </p>
        <p style="margin-top: 0.5rem; color: var(--text-muted)">
          Data from
          <a href="https://vizier.cds.unistra.fr/viz-bin/VizieR-3?-source=I/355/gaiadr3" target="_blank">Gaia DR3</a>,
          <a href="https://simbad.cds.unistra.fr/" target="_blank">SIMBAD</a>,
          <a href="https://vizier.cds.unistra.fr/" target="_blank">VizieR</a>
          | Isochrones from <a href="http://stev.oapd.inaf.it/cmd" target="_blank">PARSEC</a>
        </p>
        <p style="margin-top: 0.5rem; color: var(--text-muted)">
          Built with <a href="https://plotly.com/javascript/" target="_blank">Plotly.js</a> and
          <a href="https://aladin.cds.unistra.fr/AladinLite/" target="_blank">Aladin Lite</a> | All queries run
          client-side in JavaScript
        </p>
      </footer>
    </div>

  <script>
    // =========================
    // Global state
    // =========================
    let searchResults = [];
    let targetData = null;
    let vizierYouthData = { ewli: [], prot: [], rhk: [], lx: [] };
    let aladinViewer = null;
    let ticInfo = null;
    let exoplanetData = null;

    // =========================
    // Reference data
    // =========================

    // CGS Constants for Teq calculation
    const R_SUN_CM = 6.957e10;  // Solar radius in cm
    const AU_CM = 1.496e13;     // 1 AU in cm

    const sptMapping = [
      { bprp: -0.037, spt: 'A0' },
      { bprp: 0.377, spt: 'F0' },
      { bprp: 0.782, spt: 'G0' },
      { bprp: 0.980, spt: 'K0' },
      { bprp: 1.84, spt: 'M0' },
      { bprp: 2.50, spt: 'M3' },
      { bprp: 3.36, spt: 'M5' },
      { bprp: 4.75, spt: 'M7' }
    ];

    // Reference exoplanets for Teq plot (from literature)
    const referenceExoplanets = [
      { name: 'K2-18 b', radius: 2.61, teq: 284, teff: 3457},
      { name: 'GJ 1214 b', radius: 2.74, teq: 553, teff: 3250},
      { name: 'GJ 3470 b', radius: 4.57, teq: 604, teff: 3652},
      { name: 'TOI-270 d', radius: 2.13, teq: 394, teff: 3506},
      { name: 'L 98-59 d', radius: 1.58, teq: 416, teff: 3412},
      { name: 'GJ 9827 d', radius: 2.02, teq: 612, teff: 4255},
      { name: 'GJ 3090 b', radius: 2.13, teq: 693, teff: 3648},
      { name: 'LHS 1140 b', radius: 1.73, teq: 235, teff: 3216},
      { name: 'TRAPPIST-1 e', radius: 0.92, teq: 251, teff: 2566},
      { name: 'TRAPPIST-1 f', radius: 1.05, teq: 219, teff: 2566},
      { name: 'HD 97658 b', radius: 2.25, teq: 725, teff: 5170},
      { name: '55 Cnc e', radius: 1.88, teq: 1950, teff: 5196},
      { name: 'HD 219134 b', radius: 1.50, teq: 1015, teff: 4699},
      { name: 'HD 63433 d', radius: 1.1, teq: 1040, teff: 5688},
    ];

    const gyroClusterData = {
      pleiades: {
        age: 150, label: 'Pleiades (150 Myr)', color: '#3b82f6',
        teff: [6500, 6200, 5900, 5600, 5300, 5000, 4700, 4400, 4100, 3800, 3500, 3200],
        prot: [0.5, 1.2, 2.0, 3.2, 4.5, 6.0, 7.5, 8.5, 7.0, 4.0, 1.8, 0.6],
        scatter: [0.2, 0.4, 0.6, 0.9, 1.2, 1.5, 1.8, 2.2, 2.5, 2.0, 1.0, 0.4]
      },
      ngc3532: {
        age: 300, label: 'NGC 3532 (300 Myr)', color: '#eab308',
        teff: [6500, 6200, 5900, 5600, 5300, 5000, 4700, 4400, 4100, 3800, 3500, 3200],
        prot: [2.0, 3.5, 5.0, 7.0, 8.5, 10.0, 11.0, 11.5, 10.0, 6.5, 3.5, 1.5],
        scatter: [0.5, 0.7, 0.9, 1.1, 1.4, 1.6, 1.9, 2.2, 2.5, 2.0, 1.3, 0.8]
      },
      ngc6811: {
        age: 1000, label: 'NGC 6811 (1 Gyr)', color: '#f97316',
        teff: [6500, 6200, 5900, 5600, 5300, 5000, 4700, 4400, 4100, 3800, 3500, 3200],
        prot: [5.0, 8.0, 11.0, 13.5, 15.0, 15.5, 15.0, 14.0, 12.0, 8.0, 4.0, 2.0],
        scatter: [0.8, 1.0, 1.3, 1.6, 1.9, 2.1, 2.3, 2.6, 3.0, 2.5, 1.5, 1.0]
      }
    };

    // Manual youth indicator data for targets not yet in VizieR catalogs
    const manualYouthData = {
      'TOI-811': {
        ewli: [{ value: 133, error: 24, source: 'Carmichael+2021', url: 'https://iopscience.iop.org/article/10.3847/1538-3881/abd4e1', isALi: false }]
      },
      'TOI 811': { aliasOf: 'TOI-811' },
      'TOI811': { aliasOf: 'TOI-811' },
      'TOI-5882': {
        ewli: [{ value: 71.2, error: 6.9, source: 'Vowell+2025', url: 'https://arxiv.org/abs/2501.09795', isALi: false }]
      },
      'TOI 5882': { aliasOf: 'TOI-5882' },
      'TOI5882': { aliasOf: 'TOI-5882' }
    };

    // =========================
    // UI helpers
    // =========================
    function togglePanel(panelId) {
      const panel = document.getElementById(panelId);
      const body = panel.querySelector('.panel-body');
      const btn = panel.querySelector('.collapse-btn');

      body.classList.toggle('collapsed');
      btn.classList.toggle('collapsed');

      // Special handling for Aladin
      if (panelId === 'sky-view-panel' && !body.classList.contains('collapsed') && aladinViewer) {
        setTimeout(() => aladinViewer.view.requestRedraw(), 100);
      }
    }
    function toggleAdvanced() {
      document.getElementById('advanced-options').classList.toggle('visible');
      document.getElementById('advanced-toggle').classList.toggle('expanded');
    }

    function setStatus(message, type = 'info') {
      const statusBar = document.getElementById('status-bar');
      const statusText = document.getElementById('status-text');
      statusBar.classList.add('visible');
      statusBar.classList.remove('error', 'success');
      if (type === 'error') statusBar.classList.add('error');
      if (type === 'success') statusBar.classList.add('success');
      statusText.innerHTML = message;
    }

    function updateProgress(steps) {
      document.getElementById('progress-steps').innerHTML = steps.map(s => `
        <div class="progress-step">
          <span class="${s.status}">${s.status === 'check' ? '‚úì' : s.status === 'active' ? '‚óâ' : '‚óã'}</span>
          ${s.text}
        </div>
      `).join('');
    }

    function startWalking() {
      document.getElementById('walking-loader')?.classList.add('active');
    }

    function stopWalking() {
      document.getElementById('walking-loader')?.classList.remove('active');
    }

    function toggleExoplanetDetails() {
      const details = document.getElementById('exoplanet-details');
      const arrow = document.getElementById('exoplanet-toggle-arrow');
      if (!details || !arrow) return;

      if (details.style.display === 'none') {
        details.style.display = 'block';
        arrow.style.transform = 'rotate(0deg)';
      } else {
        details.style.display = 'none';
        arrow.style.transform = 'rotate(-90deg)';
      }
    }

  // =========================
  // Math helpers
  // =========================
  function deg2rad(x){ return x * Math.PI / 180; }
  function rad2deg(x){ return x * 180 / Math.PI; }

  function angularSeparationDeg(ra1, dec1, ra2, dec2) {
    const ra1r = deg2rad(ra1), dec1r = deg2rad(dec1);
    const ra2r = deg2rad(ra2), dec2r = deg2rad(dec2);
    const sdlat = Math.sin((dec2r - dec1r) / 2);
    const sdlon = Math.sin((ra2r - ra1r) / 2);
    const a = sdlat * sdlat + Math.cos(dec1r) * Math.cos(dec2r) * sdlon * sdlon;
    const c = 2 * Math.asin(Math.sqrt(a));
    return rad2deg(c);
  }

  function getSpectralType(bprp) {
    if (bprp == null || isNaN(bprp)) return 'N/A';
    for (let i = 0; i < sptMapping.length - 1; i++) {
      if (bprp >= sptMapping[i].bprp && bprp < sptMapping[i + 1].bprp) return sptMapping[i].spt;
    }
    if (bprp < sptMapping[0].bprp) return 'B/A';
    if (bprp >= sptMapping[sptMapping.length - 1].bprp) return 'M8+';
    return 'N/A';
  }

  function calculateAbsMag(gmag, parallax) {
    if (parallax <= 0 || gmag == null) return null;
    const dist = 1000 / parallax;
    return gmag - 5 * Math.log10(dist) + 5;
  }

  // =========================
  // Equilibrium Temperature Calculator
  // =========================
  // Formula: Teq = T_star * sqrt(R_star / (2 * a)) * (1 - A)^(1/4)
  // All units converted to CGS before calculation
  function calculateTeq(T_star_K, R_star_Rsun, a_AU, albedo) {
    if (!T_star_K || !R_star_Rsun || !a_AU || T_star_K <= 0 || R_star_Rsun <= 0 || a_AU <= 0) {
      return null;
    }
    if (albedo < 0 || albedo >= 1) {
      return null;
    }

    // Convert to CGS
    const R_star_cm = R_star_Rsun * R_SUN_CM;
    const a_cm = a_AU * AU_CM;

    // Calculate Teq
    const Teq = T_star_K * Math.sqrt(R_star_cm / (2 * a_cm)) * Math.pow(1 - albedo, 0.25);
    return Teq;
  }

  // Get temperature classification and color
  function getTeqClassification(teq) {
    if (teq < 200) return { class: 'teq-cold', label: 'Cold', color: '#60A5FA' };
    if (teq < 273) return { class: 'teq-cool', label: 'Cool', color: '#34D399' };
    if (teq < 373) return { class: 'teq-habitable-zone', label: 'Potentially Habitable', color: '#22C55E' };
    if (teq < 500) return { class: 'teq-warm', label: 'Warm', color: '#FBBF24' };
    if (teq < 800) return { class: 'teq-hot', label: 'Hot', color: '#F97316' };
    return { class: 'teq-very-hot', label: 'Very Hot', color: '#EF4444' };
  }

  // Show Teq plot for all planets in the system
    function showTeqPlot() {
      if (!exoplanetData || !exoplanetData.planets) return;

      const plotEl = document.getElementById('teq-plot-container');
      if (!plotEl) return;

      if (plotEl.style.display !== 'none' && plotEl.innerHTML !== '') {
        plotEl.style.display = 'none';
        return;
      }
      plotEl.style.display = 'block';

      const plottablePlanets = exoplanetData.planets.filter(p => p.pl_orbsmax && p.pl_rade);
      const planetColors = ['#ef4444', '#22d3ee', '#a78bfa', '#4ade80', '#fb923c'];

      // Build per-planet albedo inputs
      let albedoInputsHtml = plottablePlanets.map((p, i) => `
        <div style="display:flex; align-items:center; gap:0.4rem;">
          <span style="color:${planetColors[i % planetColors.length]}; font-weight:500;">${p.pl_name}:</span>
          <input type="number" id="teq-albedo-${i}" value="0.3" min="0" max="0.99" step="0.05"
                 style="width:60px; padding:0.2rem 0.3rem; background:var(--bg-tertiary); border:1px solid var(--border-color);
                        border-radius:4px; color:var(--text-primary); font-family:'IBM Plex Mono',monospace; font-size:0.7rem;"
                 onchange="updateTeqPlot()" onkeyup="updateTeqPlot()">
        </div>
      `).join('');

      plotEl.innerHTML = `
        <div style="display:flex; flex-wrap:wrap; align-items:center; gap:1rem; margin-bottom:0.5rem; font-size:0.8rem;">
          <span style="color:var(--text-secondary);">Albedo:</span>
          ${albedoInputsHtml}
          <span style="color:var(--text-muted); font-size:0.7rem; margin-left:0.5rem;">Earth ‚âà 0.3 | Venus ‚âà 0.77</span>
        </div>
        <div style="margin-bottom:0.5rem;">
          <button onclick="resetTeqPlotZoom()" style="background:var(--bg-tertiary); border:1px solid var(--border-color);
                  color:var(--text-secondary); padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer; font-size:0.7rem;">
            Reset Zoom
          </button>
          <button onclick="downloadTeqPlot()" style="background:var(--bg-tertiary); border:1px solid var(--border-color);
                  color:var(--text-secondary); padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer; font-size:0.7rem; margin-left:0.5rem;">
            PNG
          </button>
        </div>
        <div id="teq-plot-area"></div>
      `;

      updateTeqPlot();
    }

    // Reset zoom to default view
    function resetTeqPlotZoom() {
      const plotArea = document.getElementById('teq-plot-area');
      if (!plotArea) return;

      Plotly.relayout(plotArea, {
        'xaxis.range': [0.5, 15],
        'yaxis.range': [0, 3000]
      });
    }

    // Update/render the Teq plot with current albedos
    function updateTeqPlot() {
      if (!exoplanetData || !exoplanetData.planets) return;

      const plotArea = document.getElementById('teq-plot-area');
      if (!plotArea) return;

      const plottablePlanets = exoplanetData.planets.filter(p => p.pl_orbsmax && p.pl_rade);
      if (plottablePlanets.length === 0) return;

      // Get per-planet albedos
      const albedos = plottablePlanets.map((p, i) => {
        const input = document.getElementById(`teq-albedo-${i}`);
        let val = input ? parseFloat(input.value) : 0.3;
        if (isNaN(val) || val < 0 || val >= 1) val = 0.3;
        return val;
      });

      // Color scale based on stellar Teff
      const teffToColor = (teff) => {
        const minT = 2500, maxT = 6000;
        const norm = Math.max(0, Math.min(1, (teff - minT) / (maxT - minT)));
        const r = Math.round(80 + 175 * norm);
        const g = Math.round(120 + 50 * (1 - norm));
        const b = Math.round(220 - 150 * norm);
        return `rgb(${r},${g},${b})`;
      };

      const traces = [];

      // Habitable zone band (horizontal)
      const hzShape = {
        type: 'rect',
        xref: 'paper', yref: 'y',
        x0: 0, x1: 1,
        y0: 200, y1: 320,
        fillcolor: 'rgba(34, 197, 94, 0.15)',
        line: { width: 0 },
        layer: 'below'
      };

      // Super-Earth region (vertical)
      const superEarthShape = {
        type: 'rect',
        xref: 'x', yref: 'paper',
        x0: 1.25, x1: 4,
        y0: 0, y1: 1,
        fillcolor: 'rgba(167, 139, 250, 0.12)',
        line: { width: 0 },
        layer: 'below'
      };

      // Reference planets trace (always A=0.3 from literature)
      traces.push({
        x: referenceExoplanets.map(p => p.radius),
        y: referenceExoplanets.map(p => p.teq),
        mode: 'markers',
        type: 'scatter',
        name: 'Known Exoplanets',
        text: referenceExoplanets.map(p => p.name),
        marker: {
          size: 12,
          color: referenceExoplanets.map(p => teffToColor(p.teff)),
          line: { color: 'rgba(0,0,0,0.3)', width: 1 },
          opacity: 0.8
        },
        hovertemplate: '<b>%{text}</b><br>R = %{x:.2f} R‚äï<br>Teq = %{y:.0f} K<extra></extra>'
      });

      // Target system planets - each as separate trace for legend
      const planetColors = ['#ef4444', '#22d3ee', '#a78bfa', '#4ade80', '#fb923c'];

      plottablePlanets.forEach((p, i) => {
        const albedo = albedos[i];
        const teq = calculateTeq(exoplanetData.st_teff, exoplanetData.st_rad, p.pl_orbsmax, albedo);
        if (!teq) return;

        traces.push({
          x: [p.pl_rade],
          y: [teq],
          mode: 'markers',
          type: 'scatter',
          name: `${p.pl_name} (${teq.toFixed(0)} K, A=${albedo})`,
          marker: {
            size: 14,
            color: planetColors[i % planetColors.length],
            symbol: 'star',
            line: { color: '#000', width: 1 }
          },
          hovertemplate: `<b>${p.pl_name}</b><br>R = %{x:.2f} R‚äï<br>Teq = %{y:.0f} K (A=${albedo})<extra></extra>`
        });
      });

      const layout = {
        paper_bgcolor: '#ffffff',
        plot_bgcolor: '#ffffff',
        font: { color: '#1a1a2e', family: 'IBM Plex Sans', size: 11 },
        xaxis: {
          title: 'Radius [R‚äï]',
          range: [0.5, 15],
          gridcolor: 'rgba(100,100,100,0.2)',
          zerolinecolor: 'rgba(100,100,100,0.3)',
          dtick: 2
        },
        yaxis: {
          title: 'Equilibrium Temperature [K]',
          range: [0, 3000],
          gridcolor: 'rgba(100,100,100,0.2)',
          zerolinecolor: 'rgba(100,100,100,0.3)',
          dtick: 500
        },
        shapes: [superEarthShape, hzShape],
        annotations: [
          {
            x: 14.5, y: 260,
            text: 'Habitable Zone',
            showarrow: false,
            font: { size: 9, color: 'rgba(34, 197, 94, 0.8)' },
            xanchor: 'right'
          },
          {
            x: 2.85, y: 100,
            text: 'Super-Earths',
            showarrow: false,
            font: { size: 9, color: 'rgba(167, 139, 250, 0.8)' },
            xanchor: 'center'
          }
        ],
        showlegend: true,
        legend: {
          x: 0.02, y: 0.98,
          bgcolor: 'rgba(255,255,255,0.9)',
          bordercolor: 'rgba(0,0,0,0.1)',
          borderwidth: 1,
          font: { size: 10 }
        },
        margin: { t: 20, r: 20, b: 50, l: 60 },
        hovermode: 'closest'
      };

      Plotly.react(plotArea, traces, layout, { responsive: true, displayModeBar: false });
    }
  // =========================
  // Galactic conversion (unchanged)
  // =========================
  function equatorialToGalactic(ra, dec) {
    const ra_ngp = deg2rad(192.85948);
    const dec_ngp = deg2rad(27.12825);
    const l_ncp = deg2rad(122.93192);

    const ra_rad = deg2rad(ra);
    const dec_rad = deg2rad(dec);

    const sin_b = Math.sin(dec_ngp) * Math.sin(dec_rad) +
      Math.cos(dec_ngp) * Math.cos(dec_rad) * Math.cos(ra_rad - ra_ngp);
    const b = rad2deg(Math.asin(sin_b));

    const y = Math.cos(dec_rad) * Math.sin(ra_rad - ra_ngp);
    const x = Math.cos(dec_ngp) * Math.sin(dec_rad) -
      Math.sin(dec_ngp) * Math.cos(dec_rad) * Math.cos(ra_rad - ra_ngp);

    let l = rad2deg(l_ncp) - rad2deg(Math.atan2(y, x));

    while (l < 0) l += 360;
    while (l >= 360) l -= 360;
    if (l > 180) l -= 360;

    return { l, b };
  }

  function displayGalacticMap(ra, dec) {
    const container = document.getElementById('galactic-plot');
    const galactic = equatorialToGalactic(ra, dec);

    const traces = [
      {
        x: [-180, 180],
        y: [0, 0],
        mode: 'lines',
        name: 'Galactic Plane',
        line: { color: 'rgba(150, 130, 100, 0.5)', width: 1, dash: 'dash' },
        hoverinfo: 'name'
      },
      {
        x: [galactic.l],
        y: [galactic.b],
        mode: 'markers',
        name: targetData?._resolvedName || 'Target',
        marker: { size: 16, color: '#ef4444', symbol: 'star', line: { color: '#000', width: 2 } },
        hovertemplate: `<b>${targetData?._resolvedName || 'Target'}</b><br>l = ${galactic.l.toFixed(2)}¬∞<br>b = ${galactic.b.toFixed(2)}¬∞<extra></extra>`
      }
    ];

    const layout = {
      paper_bgcolor: '#1a1a2e',
      plot_bgcolor: '#0f0f1a',
      font: { color: '#f0f4f8', family: 'IBM Plex Sans' },
      images: [{
        source: 'https://raw.githubusercontent.com/msoaresfurtado/WebPage/main/tools/MW_edgeon_edr3_unannotate.jpg',
        xref: 'x', yref: 'y',
        x: 180, y: 90,
        sizex: 360, sizey: 180,
        sizing: 'stretch',
        opacity: 0.6,
        layer: 'below'
      }],
      xaxis: { title: { text: 'Galactic Longitude l (¬∞)', font: { size: 12 } }, range: [180, -180], dtick: 60, showgrid: false, zeroline: false, showticklabels: false },
      yaxis: { title: { text: 'Galactic Latitude b (¬∞)', font: { size: 12 } }, range: [-90, 90], dtick: 30, showgrid: false, zeroline: false, showticklabels: false, scaleanchor: 'x', scaleratio: 0.5 },
      legend: { x: 0.01, y: 0.99, bgcolor: 'rgba(0, 0, 0, 0.5)', font: { size: 10 } },
      margin: { t: 10, r: 20, b: 10, l: 45 },
    };

    Plotly.newPlot(container, traces, layout, { responsive: true });
  }

  function downloadGalacticPlot() {
    Plotly.downloadImage('galactic-plot', {
      format: 'png',
      width: 350,
      height: 300,
      scale: 2,
      filename: `GaiaDR3_${targetData?.source_id}_galactic`
    });
  }

  function downloadGyroPlot() {
    Plotly.downloadImage('gyro-plot', {
      format: 'png',
      width: 800,
      height: 450,
      scale: 3,
      filename: `GaiaDR3_${targetData?.source_id}_gyro`
    });
  }

  // =========================
  // Gaia TAP (VizieR) helper
  // =========================
  async function queryGaia(query) {
    const url = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';

    const colMapping = {
      'source_id': 'Source',
      'ra': 'RA_ICRS',
      'dec': 'DE_ICRS',
      'parallax': 'Plx',
      'parallax_error': 'e_Plx',
      'pmra': 'pmRA',
      'pmdec': 'pmDE',
      'radial_velocity': 'RV',
      'radial_velocity_error': 'e_RV',
      'phot_g_mean_mag': 'Gmag',
      'phot_bp_mean_mag': 'BPmag',
      'phot_rp_mean_mag': 'RPmag',
      'bp_rp': '"BP-RP"',
      'ruwe': 'RUWE',
      'teff_gspphot': 'Teff',
      'logg_gspphot': 'logg'
    };

    let vizierQuery = query
      .replace(/gaiadr3\.gaia_source/gi, '"I/355/gaiadr3"')
      .replace(/gaiadr3\.astrophysical_parameters/gi, '"I/355/paramp"');

    for (const [esa, viz] of Object.entries(colMapping)) {
      vizierQuery = vizierQuery.replace(new RegExp(`\\b${esa}\\b`, 'gi'), viz);
    }

    vizierQuery = vizierQuery.replace(/Source\s*=\s*(\d+)/gi, "Source = '$1'");

    const params = new URLSearchParams({
      REQUEST: 'doQuery',
      LANG: 'ADQL',
      FORMAT: 'json',
      QUERY: vizierQuery
    });

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params
    });

    if (!response.ok) throw new Error('Gaia query failed');

    // Preserve 19-digit source_id precision
    let text = await response.text();
    text = text.replace(/([:\[,]\s*)(\d{16,})(\s*[,\}\]])/g, '$1"$2"$3');
    const data = JSON.parse(text);

    if (data.metadata) {
      const reverseMapping = {};
      for (const [esa, viz] of Object.entries(colMapping)) reverseMapping[viz.replace(/"/g, '')] = esa;
      data.metadata = data.metadata.map(m => ({ ...m, name: reverseMapping[m.name] || m.name.toLowerCase() }));
    }

    return data;
  }

  // =========================
  // SIMBAD resolveIdentifier()
  // - NOW picks closest SIMBAD match
  // =========================
  async function resolveIdentifier(input) {
    const cleaned = input.trim();

    // Gaia DR3 prefix
    const gaiaMatch = cleaned.match(/^Gaia\s*DR3\s*(\d+)$/i);
    if (gaiaMatch) return { gaiaId: gaiaMatch[1], resolvedName: null, ra: null, dec: null };

    // Raw Gaia source_id
    if (/^\d{15,25}$/.test(cleaned)) return { gaiaId: cleaned, resolvedName: null, ra: null, dec: null };

    const simbadUrl = 'https://simbad.cds.unistra.fr/simbad/sim-tap/sync';

    // Build name variants (same as before)
    const variants = [cleaned];

    const toiMatch = cleaned.match(/^TOI[-\s]*(\d+\.?\d*)$/i);
    if (toiMatch) variants.push(`TOI-${toiMatch[1]}`, `TOI ${toiMatch[1]}`, `TOI${toiMatch[1]}`);

    const ticMatch = cleaned.match(/^TIC\s*(\d+)$/i);
    if (ticMatch) variants.push(`TIC ${ticMatch[1]}`, `TIC${ticMatch[1]}`);

    const hdMatch = cleaned.match(/^HD\s*(\d+)$/i);
    if (hdMatch) variants.push(`HD ${hdMatch[1]}`, `HD${hdMatch[1]}`);

    const keltMatch = cleaned.match(/^KELT[-\s]*(\d+[A-Za-z]?)$/i);
    if (keltMatch) variants.push(`KELT-${keltMatch[1]}`, `KELT ${keltMatch[1]}`, `KELT${keltMatch[1]}`);

    // K2 targets (e.g., K2-33, K2 33, K233)
    const k2Match = cleaned.match(/^K2[-\s]*(\d+[A-Za-z]?)$/i);
    if (k2Match) variants.push(`K2-${k2Match[1]}`, `K2 ${k2Match[1]}`, `K2${k2Match[1]}`);

    // WASP targets (e.g., WASP-12, WASP 12)
    const waspMatch = cleaned.match(/^WASP[-\s]*(\d+[A-Za-z]?)$/i);
    if (waspMatch) variants.push(`WASP-${waspMatch[1]}`, `WASP ${waspMatch[1]}`, `WASP${waspMatch[1]}`);

    // HAT-P targets (e.g., HAT-P-1, HATP1)
    const hatpMatch = cleaned.match(/^HAT[-\s]*P[-\s]*(\d+[A-Za-z]?)$/i);
    if (hatpMatch) variants.push(`HAT-P-${hatpMatch[1]}`, `HAT-P ${hatpMatch[1]}`, `HATP${hatpMatch[1]}`, `HAT-P${hatpMatch[1]}`);

    // EPIC targets (K2 input catalog)
    const epicMatch = cleaned.match(/^EPIC\s*(\d+)$/i);
    if (epicMatch) variants.push(`EPIC ${epicMatch[1]}`, `EPIC${epicMatch[1]}`);

    // Kepler targets (e.g., Kepler-22, Kepler 22)
    const keplerMatch = cleaned.match(/^Kepler[-\s]*(\d+[A-Za-z]?)$/i);
    if (keplerMatch) variants.push(`Kepler-${keplerMatch[1]}`, `Kepler ${keplerMatch[1]}`, `Kepler${keplerMatch[1]}`);

    // Collect all SIMBAD oid candidates across variants
    const oidSet = new Set();
    const variantHits = []; // {variant, oid}
    for (const variant of variants) {
      try {
        const identQuery = `SELECT oidref, id FROM ident WHERE id = '${variant.replace(/'/g, "''")}'`;
        const identParams = new URLSearchParams({ REQUEST: 'doQuery', LANG: 'ADQL', FORMAT: 'json', QUERY: identQuery });
        const identResp = await fetch(simbadUrl, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: identParams });
        if (!identResp.ok) continue;

        const identData = await identResp.json();
        if (!identData.data || identData.data.length === 0) continue;

        for (const row of identData.data) {
          const oid = row[0];
          if (oid != null) {
            oidSet.add(Number(oid));
            variantHits.push({ variant, oid: Number(oid) });
          }
        }
      } catch (e) {
        // continue
      }
    }

    if (oidSet.size === 0) return null;

    // Pull basic info for all candidate oids
    const oidList = Array.from(oidSet).slice(0, 200); // safety cap
    const basicQuery = `SELECT oid, main_id, ra, dec FROM basic WHERE oid IN (${oidList.join(',')})`;
    const basicParams = new URLSearchParams({ REQUEST: 'doQuery', LANG: 'ADQL', FORMAT: 'json', QUERY: basicQuery });

    const basicResp = await fetch(simbadUrl, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: basicParams });
    if (!basicResp.ok) return null;

    const basicData = await basicResp.json();
    if (!basicData.data || basicData.data.length === 0) return null;

    // Helper: fetch Gaia DR3 id for a SIMBAD oid
    async function fetchGaiaIdForOid(oid) {
      try {
        const q = `SELECT id FROM ident WHERE oidref = ${oid} AND id LIKE 'Gaia DR3 %'`;
        const p = new URLSearchParams({ REQUEST: 'doQuery', LANG: 'ADQL', FORMAT: 'json', QUERY: q });
        const r = await fetch(simbadUrl, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: p });
        if (!r.ok) return null;
        const d = await r.json();
        if (!d.data || d.data.length === 0) return null;
        const s = d.data[0][0];
        const m = String(s).match(/Gaia DR3\s+(\d+)/);
        return m ? m[1] : null;
      } catch {
        return null;
      }
    }

    // Helper: get Gaia coords for Gaia source_id
    async function fetchGaiaCoords(gaiaId) {
      try {
        const q = `SELECT source_id, ra, dec, parallax FROM gaiadr3.gaia_source WHERE source_id = ${gaiaId}`;
        const r = await queryGaia(q);
        if (!r.data || r.data.length === 0) return null;
        const cols = r.metadata.map(m => m.name);
        const iRa = cols.indexOf('ra');
        const iDec = cols.indexOf('dec');
        const iPlx = cols.indexOf('parallax');
        return { ra: r.data[0][iRa], dec: r.data[0][iDec], parallax: r.data[0][iPlx] };
      } catch {
        return null;
      }
    }

    // Helper: cone search Gaia around SIMBAD coords (if SIMBAD lacks Gaia DR3 x-id)
    async function coneGaiaAround(ra, dec, radiusArcsec = 5) {
      const radiusDeg = radiusArcsec / 3600;
      const q = `
        SELECT source_id, ra, dec, parallax,
               DISTANCE(POINT('ICRS', ra, dec), POINT('ICRS', ${ra}, ${dec})) AS dist
        FROM gaiadr3.gaia_source
        WHERE 1=CONTAINS(POINT('ICRS', ra, dec), CIRCLE('ICRS', ${ra}, ${dec}, ${radiusDeg}))
        ORDER BY dist ASC
      `;
      const r = await queryGaia(q);
      if (!r.data || r.data.length === 0) return null;
      const cols = r.metadata.map(m => m.name);
      const iSrc = cols.indexOf('source_id');
      const iRa = cols.indexOf('ra');
      const iDec = cols.indexOf('dec');
      return { gaiaId: String(r.data[0][iSrc]), ra: r.data[0][iRa], dec: r.data[0][iDec] };
    }

    // Score each SIMBAD candidate by Gaia‚ÜîSIMBAD separation; pick minimum
    let best = null; // {scoreArcsec, gaiaId, resolvedName, simbadRa, simbadDec}
    for (const row of basicData.data) {
      const oid = Number(row[0]);
      const mainId = row[1];
      const raS = Number(row[2]);
      const decS = Number(row[3]);

      let gaiaId = await fetchGaiaIdForOid(oid);
      let gaiaCoords = null;

      if (gaiaId) {
        gaiaCoords = await fetchGaiaCoords(gaiaId);
      } else {
        const cone = await coneGaiaAround(raS, decS, 5);
        if (cone?.gaiaId) {
          gaiaId = cone.gaiaId;
          gaiaCoords = { ra: cone.ra, dec: cone.dec };
        }
      }

      if (!gaiaId || !gaiaCoords?.ra || !gaiaCoords?.dec) continue;

      const sepArcsec = angularSeparationDeg(raS, decS, gaiaCoords.ra, gaiaCoords.dec) * 3600;
      if (best == null || sepArcsec < best.scoreArcsec) {
        best = { scoreArcsec: sepArcsec, gaiaId, resolvedName: mainId, ra: raS, dec: decS };
      }
    }

    if (!best) return null;

    console.log(`Resolved "${cleaned}" => SIMBAD "${best.resolvedName}" ; Gaia DR3 ${best.gaiaId} ; sep=${best.scoreArcsec.toFixed(2)}"`);
    return { gaiaId: best.gaiaId, resolvedName: best.resolvedName, ra: best.ra, dec: best.dec };
  }

  // =========================
  // Target Gaia fetch (join gaia_source + paramp)
  // =========================
  async function fetchTargetGaiaById(gaiaId) {
    const q = `
      SELECT g.source_id, g.ra, g.dec, g.parallax, g.parallax_error, g.pmra, g.pmdec,
             g.radial_velocity, g.radial_velocity_error, g.phot_g_mean_mag, g.phot_bp_mean_mag,
             g.phot_rp_mean_mag, g.bp_rp, g.ruwe,
             p.teff_gspphot, p.logg_gspphot
      FROM gaiadr3.gaia_source AS g
      LEFT JOIN gaiadr3.astrophysical_parameters AS p
      ON g.source_id = p.source_id
      WHERE g.source_id = ${gaiaId}
    `;
    const res = await queryGaia(q);
    if (!res.data || res.data.length === 0) return null;

    const cols = res.metadata.map(m => m.name);
    const row = res.data[0];
    const obj = {};
    cols.forEach((c, i) => obj[c] = (c === 'source_id' ? String(row[i]) : row[i]));
    return obj;
  }

  // =========================
  // Target display + external links + Aladin
  // =========================
  function displayTargetInfo(target) {
    const container = document.getElementById('target-info');
    const distPc = target.parallax > 0 ? 1000 / target.parallax : null;
    const absG = distPc ? target.phot_g_mean_mag - 5 * Math.log10(distPc) + 5 : null;

    let html = '';
    if (target._resolvedName) {
      html += `<div class="info-item" style="grid-column: 1 / -1;">
        <div class="label">Name</div>
        <div class="value highlight" style="font-size: 1.1rem;">${target._resolvedName}</div>
      </div>`;
    }

    html += `
      <div class="info-item"><div class="label">Gaia DR3 Source ID</div><div class="value">${target.source_id}</div></div>
      <div class="info-item"><div class="label">RA / Dec</div><div class="value">${target.ra?.toFixed(5)}¬∞ / ${target.dec?.toFixed(5)}¬∞</div></div>
      <div class="info-item"><div class="label">Distance</div><div class="value highlight">${distPc?.toFixed(1) || 'N/A'} pc</div></div>
      <div class="info-item"><div class="label">G mag / M<sub>G</sub></div><div class="value">${target.phot_g_mean_mag?.toFixed(2)} / ${absG?.toFixed(2) || 'N/A'}</div></div>
      <div class="info-item"><div class="label">BP - RP</div><div class="value">${target.bp_rp?.toFixed(3) || 'N/A'}</div></div>
      <div class="info-item"><div class="label">Spectral Type</div><div class="value highlight">${getSpectralType(target.bp_rp)}</div></div>
      <div class="info-item"><div class="label">T<sub>eff</sub></div><div class="value">${target.teff_gspphot ? Math.round(target.teff_gspphot) + ' K' : 'N/A'}</div></div>
      <div class="info-item"><div class="label">Radial Velocity</div><div class="value">${target.radial_velocity != null ? target.radial_velocity.toFixed(2) : 'N/A'} km/s</div></div>
      <div class="info-item"><div class="label">RUWE</div><div class="value">${target.ruwe?.toFixed(2) || 'N/A'}</div></div>
    `;
    container.innerHTML = html;
  }

  function displayExternalLinks(target, resolvedName) {
    const container = document.getElementById('external-links');
    const simbadId = resolvedName || `Gaia DR3 ${target.source_id}`;

    container.innerHTML = `
      <a href="https://simbad.cds.unistra.fr/simbad/sim-id?Ident=${encodeURIComponent(simbadId)}" target="_blank" class="external-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
        SIMBAD
      </a>
      <a href="https://exofop.ipac.caltech.edu/tess/target.php?id=${encodeURIComponent(simbadId)}" target="_blank" class="external-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle></svg>
        ExoFOP
      </a>
      <a href="https://vizier.cds.unistra.fr/viz-bin/VizieR-4?-source=&-c=${target.ra}+${target.dec}&-c.rs=3&-out.max=unlimited&-out.all=2" target="_blank" class="external-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"></rect><path d="M3 9h18M9 21V9"></path></svg>
        VizieR
      </a>
      <a href="https://heasarc.gsfc.nasa.gov/wsgi-scripts/TESS/TESS-point_Web_Tool/TESS-point_Web_Tool/wtv_v2.0.py/?ra=${target.ra}&dec=${target.dec}" target="_blank" class="external-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
        TESS-point
      </a>
    `;
  }

  function initAladinViewer(ra, dec) {
    const container = document.getElementById('aladin-lite-div');
    if (!container) return;

    if (typeof A === 'undefined') {
      setTimeout(() => initAladinViewer(ra, dec), 500);
      return;
    }

    container.innerHTML = '';
    aladinViewer = A.aladin('#aladin-lite-div', {
      target: `${ra} ${dec}`,
      fov: 0.05,
      survey: 'P/DSS2/color',
      showReticle: true,
      showZoomControl: true,
      showFullscreenControl: true,
      showLayersControl: true,
      reticleColor: '#22d3ee',
      reticleSize: 22
    });

    const catalog = A.catalog({ name: 'Target', sourceSize: 18, color: '#ef4444' });
    aladinViewer.addCatalog(catalog);
    catalog.addSources([A.marker(ra, dec, { popupTitle: 'Target' })]);

    document.getElementById('fov-value').textContent = "6' FOV";
  }

  function addComovingToAladin(candidates, target) {
    if (!aladinViewer || candidates.length === 0) return;

    const comovers = candidates.filter(c => c.sep_3d > 0.01 && c.ra != null && c.dec != null);
    if (comovers.length === 0) return;

    const comovingCatalog = A.catalog({ name: 'Comoving', sourceSize: 12, color: '#22d3ee', shape: 'cross' });
    aladinViewer.addCatalog(comovingCatalog);

    const sources = comovers.map(c => A.source(c.ra, c.dec, {
      name: `Gaia DR3 ${c.source_id}`,
      popupDesc: `Sep: ${c.sep_3d?.toFixed(2)} pc<br>Voff: ${c.voff?.toFixed(2)} km/s`
    }));
    comovingCatalog.addSources(sources);
  }

  // =========================
  // Convergent-point kinematics (NEW)
  // =========================
  function velocityVectorEquatorial(star) {
    // Returns heliocentric space-velocity vector V in equatorial Cartesian (km/s)
    // Uses Gaia pmra/pmdec/parallax and RV (if missing, uses 0 and marks incomplete)
    const ra = deg2rad(star.ra);
    const dec = deg2rad(star.dec);

    const dist = (star.parallax > 0) ? (1000 / star.parallax) : null;
    if (!dist || star.pmra == null || star.pmdec == null) return { V: null, hasRV: false };

    const k = 4.74047; // km/s per (arcsec/yr * pc)
    const vAlpha = k * star.pmra * dist / 1000;   // pmra is mas/yr
    const vDelta = k * star.pmdec * dist / 1000;

    const vRad = (star.radial_velocity != null && !isNaN(star.radial_velocity)) ? star.radial_velocity : 0;
    const hasRV = (star.radial_velocity != null && !isNaN(star.radial_velocity));

    const cosRa = Math.cos(ra), sinRa = Math.sin(ra);
    const cosDec = Math.cos(dec), sinDec = Math.sin(dec);

    // Unit vectors at star position
    const rhat = [cosDec * cosRa, cosDec * sinRa, sinDec];
    const ahat = [-sinRa, cosRa, 0]; // increasing RA direction
    const dhat = [-sinDec * cosRa, -sinDec * sinRa, cosDec]; // increasing Dec direction

    // V = vAlpha*ahat + vDelta*dhat + vRad*rhat
    const V = [
      vAlpha * ahat[0] + vDelta * dhat[0] + vRad * rhat[0],
      vAlpha * ahat[1] + vDelta * dhat[1] + vRad * rhat[1],
      vAlpha * ahat[2] + vDelta * dhat[2] + vRad * rhat[2]
    ];

    return { V, hasRV };
  }

  function dot(a, b) { return a[0]*b[0] + a[1]*b[1] + a[2]*b[2]; }

  function tangentBasis(raDeg, decDeg) {
    const ra = deg2rad(raDeg);
    const dec = deg2rad(decDeg);

    const cosRa = Math.cos(ra), sinRa = Math.sin(ra);
    const cosDec = Math.cos(dec), sinDec = Math.sin(dec);

    const rhat = [cosDec * cosRa, cosDec * sinRa, sinDec];
    const ahat = [-sinRa, cosRa, 0];
    const dhat = [-sinDec * cosRa, -sinDec * sinRa, cosDec];
    return { rhat, ahat, dhat };
  }

  // Velocity offset = || (v_tan_obs - v_tan_pred) || in the candidate tangent plane (km/s)
  function computeVelocityOffsetConvergent(candidateStar, targetVelocityVec) {
    if (!targetVelocityVec || !candidateStar?.parallax || candidateStar.parallax <= 0) return NaN;
    if (candidateStar.pmra == null || candidateStar.pmdec == null) return NaN;

    const distC = 1000 / candidateStar.parallax;
    const k = 4.74047;

    const vAlphaObs = k * candidateStar.pmra * distC / 1000;
    const vDeltaObs = k * candidateStar.pmdec * distC / 1000;

    const { ahat, dhat } = tangentBasis(candidateStar.ra, candidateStar.dec);

    const vAlphaPred = dot(targetVelocityVec, ahat);
    const vDeltaPred = dot(targetVelocityVec, dhat);

    const dvA = vAlphaObs - vAlphaPred;
    const dvD = vDeltaObs - vDeltaPred;

    return Math.sqrt(dvA*dvA + dvD*dvD);
  }

  // Predicted RV at candidate = V ¬∑ rhat(candidate) (km/s)
  function computePredictedRVConvergent(candidateStar, targetVelocityVec, targetHasRV) {
    if (!targetHasRV) return null; // avoid pretending we know the radial component
    if (!targetVelocityVec) return null;
    const { rhat } = tangentBasis(candidateStar.ra, candidateStar.dec);
    return dot(targetVelocityVec, rhat);
  }

  // =========================
  // Comoving search (UPDATED: uses convergent-point kinematics; NO RV CUT)
  // =========================
  async function runComovingSearch() {
    if (!targetData) return;

    const btn = document.getElementById('btn-comoving');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Searching...';

    const velocityLimit = parseFloat(document.getElementById('velocity-limit').value) || 5.0;
    const searchRadius = parseFloat(document.getElementById('search-radius').value) || 5.0;

    try {
      if (!targetData.parallax || targetData.parallax <= 0) throw new Error('Target has no valid parallax');
      if (targetData.pmra == null || targetData.pmdec == null) throw new Error('Target missing proper motion');

      const targetDist = 1000 / targetData.parallax;

      let searchRadDeg;
      if (searchRadius >= targetDist) searchRadDeg = 60;
      else searchRadDeg = Math.atan(searchRadius / targetDist) * 180 / Math.PI;

      const minParallax = 1000 / (targetDist + searchRadius);

      const neighborQuery = `
        SELECT source_id, ra, dec, parallax, parallax_error, pmra, pmdec,
               radial_velocity, radial_velocity_error, phot_g_mean_mag, phot_bp_mean_mag,
               phot_rp_mean_mag, bp_rp, ruwe, teff_gspphot
        FROM gaiadr3.gaia_source
        WHERE 1=CONTAINS(POINT('ICRS', ra, dec), CIRCLE('ICRS', ${targetData.ra}, ${targetData.dec}, ${searchRadDeg}))
          AND parallax > ${minParallax * 0.5}
          AND parallax_error < 0.5
      `;
      const neighborResult = await queryGaia(neighborQuery);

      if (!neighborResult.data || neighborResult.data.length === 0) throw new Error('No neighbors found');

      const targetVel = velocityVectorEquatorial(targetData);
      const Vt = targetVel.V;
      const targetHasRV = targetVel.hasRV;

      const neighborCols = neighborResult.metadata.map(m => m.name);
      const candidates = [];

      for (const nrow of neighborResult.data) {
        const star = {};
        neighborCols.forEach((col, i) => {
          const colName = col.toLowerCase();
          star[colName] = (colName === 'source_id') ? String(nrow[i]) : nrow[i];
        });

        if (!star.parallax || star.parallax <= 0) continue;
        if (star.pmra == null || star.pmdec == null) continue;

        const starDist = 1000 / star.parallax;

        const angSep = angularSeparationDeg(targetData.ra, targetData.dec, star.ra, star.dec);
        const angSepRad = deg2rad(angSep);

        const sep3d = Math.sqrt(
          starDist * starDist + targetDist * targetDist -
          2 * starDist * targetDist * Math.cos(angSepRad)
        );
        if (sep3d > searchRadius) continue;

        const voff = computeVelocityOffsetConvergent(star, Vt);
        if (!isFinite(voff)) continue;
        if (voff > velocityLimit) continue;

        star.sep_deg = angSep;
        star.sep_3d = sep3d;
        star.voff = voff;
        star.spt = getSpectralType(star.bp_rp);
        star.rv_pred = computePredictedRVConvergent(star, Vt, targetHasRV);

        candidates.push(star);
      }

      candidates.sort((a, b) => a.sep_3d - b.sep_3d);
      candidates.forEach((c, i) => { c.index = i + 1; });

      searchResults = candidates;

      document.getElementById('comoving-panel').style.display = 'block';
      displayTable(candidates);
      displayCMD(candidates, targetData);
      addComovingToAladin(candidates, targetData);

      const rvNote = targetHasRV ? '' : ' (Target RV missing: RV_pred suppressed)';
      setStatus(`Found ${candidates.length} comoving candidates within ${searchRadius} pc${rvNote}. Results at the bottom of the page.`, 'success');

    } catch (e) {
      console.error('Comoving search error:', e);
      setStatus(`Comoving search error: ${e.message}`, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <circle cx="4" cy="4" r="2"></circle>
          <circle cx="20" cy="4" r="2"></circle>
          <circle cx="4" cy="20" r="2"></circle>
          <circle cx="20" cy="20" r="2"></circle>
        </svg>
        Comoving Search
      `;
    }
  }

  // =========================
  // Table + CSV
  // =========================
  function fmt(x, nd=2) {
    if (x == null || !isFinite(x)) return 'N/A';
    return Number(x).toFixed(nd);
  }

  function displayTable(candidates) {
    const tbody = document.getElementById('results-tbody');
    const badge = document.getElementById('candidate-count');
    badge.textContent = `${candidates.length} stars`;

    tbody.innerHTML = candidates.map((c, i) => {
      const isTarget = (targetData && c.source_id === targetData.source_id) || (c.sep_3d != null && c.sep_3d < 1e-3);
      const trClass = isTarget ? 'target-row' : '';
      const rvPredStr = (c.rv_pred == null) ? 'N/A' : fmt(c.rv_pred, 2);
      const rvObsStr = (c.radial_velocity == null) ? 'N/A' : fmt(c.radial_velocity, 2);

      return `
        <tr class="${trClass}">
          <td>${i + 1}</td>
          <td>${c.source_id}</td>
          <td>${fmt(c.ra, 5)}</td>
          <td>${fmt(c.dec, 5)}</td>
          <td>${fmt(c.phot_g_mean_mag, 3)}</td>
          <td>${c.bp_rp != null ? fmt(c.bp_rp, 3) : 'N/A'}</td>
          <td>${fmt(c.voff, 2)}</td>
          <td>${fmt(c.sep_deg, 4)}</td>
          <td>${fmt(c.sep_3d, 3)}</td>
          <td>${rvPredStr}</td>
          <td>${rvObsStr}</td>
          <td>${c.spt || 'N/A'}</td>
          <td>${c.ruwe != null ? fmt(c.ruwe, 2) : 'N/A'}</td>
        </tr>
      `;
    }).join('');
  }

  function downloadCSV() {
    const rows = searchResults || [];
    if (!rows.length) return;

    const header = [
      'index','source_id','ra','dec','phot_g_mean_mag','bp_rp','voff_kms','sep_deg','sep3d_pc',
      'rv_pred_kms','rv_obs_kms','ruwe','spt','parallax','pmra','pmdec'
    ];

    const lines = [header.join(',')];

    for (let i=0; i<rows.length; i++) {
      const r = rows[i];
      const line = [
        i+1,
        r.source_id,
        r.ra, r.dec,
        r.phot_g_mean_mag,
        r.bp_rp,
        r.voff,
        r.sep_deg,
        r.sep_3d,
        (r.rv_pred == null ? '' : r.rv_pred),
        (r.radial_velocity == null ? '' : r.radial_velocity),
        r.ruwe,
        (r.spt || ''),
        r.parallax,
        r.pmra,
        r.pmdec
      ].map(v => (v == null ? '' : String(v)));
      lines.push(line.join(','));
    }

    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `GaiaDR3_${targetData?.source_id || 'target'}_comoving.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
  }

  // =========================
  // CMD (same as your v2.1; kept intact)
  // =========================
  const spectralTypeColors = [
    { range: [-1, -0.26], color: 'rgba(91, 124, 255, 0.15)', label: 'O' },
    { range: [-0.265, -0.038], color: 'rgba(105, 136, 255, 0.15)', label: 'B' },
    { range: [-0.038, 0.327], color: 'rgba(147, 170, 255, 0.15)', label: 'A' },
    { range: [0.327, 0.767], color: 'rgba(221, 222, 255, 0.15)', label: 'F' },
    { range: [0.767, 0.984], color: 'rgba(255, 235, 223, 0.20)', label: 'G' },
    { range: [0.984, 1.85], color: 'rgba(255, 177, 119, 0.20)', label: 'K' },
    { range: [1.85, 3.5], color: 'rgba(255, 164, 72, 0.15)', label: 'M' },
  ];

  const instabilityStrip = {
    blueX: [-0.1937, 0.65894],
    blueY: [4.3871, -4.87],
    redX: [0.31126, 1.6108],
    redY: [4.7419, -4.871]
  };

  const stripX = [...instabilityStrip.blueX, ...instabilityStrip.redX.slice().reverse()];
  const stripY = [...instabilityStrip.blueY, ...instabilityStrip.redY.slice().reverse()];

  function displayCMD(candidates, target) {
    const container = document.getElementById('cmd-plot');

    const bprp = candidates.map(c => c.bp_rp);
    const absG = candidates.map(c => calculateAbsMag(c.phot_g_mean_mag, c.parallax));
    const voff = candidates.map(c => c.voff);

    const targetBpRp = target.bp_rp;
    const targetAbsMag = calculateAbsMag(target.phot_g_mean_mag, target.parallax);

    const shapes = spectralTypeColors.map(band => ({
      type: 'rect', xref: 'x', yref: 'paper',
      x0: band.range[0], x1: band.range[1], y0: 0, y1: 1,
      fillcolor: band.color, line: { width: 0 }, layer: 'below'
    }));

    // PARSEC arrays (your v2.1)
    const myr100_bp_rp = [-0.180,-0.186,-0.192,-0.194,-0.198,-0.203,-0.204,-0.205,-0.205,-0.205,-0.206,-0.205,-0.204,-0.203,-0.202,-0.199,-0.196,-0.195,-0.189,-0.187,-0.183,-0.177,-0.173,-0.167,-0.165,-0.164,-0.156,-0.152,-0.141,-0.136,-0.129,-0.118,-0.117,-0.097,-0.084,-0.070,-0.053,-0.053,-0.043,-0.032,-0.021,-0.021,-0.008,0.006,0.023,0.041,0.063,0.088,0.118,0.127,0.154,0.197,0.243,0.252,0.293,0.345,0.398,0.448,0.490,0.530,0.568,0.605,0.648,0.691,0.724,0.741,0.795,0.802,0.823,0.916,0.988,1.066,1.069,1.160,1.271,1.448,1.449,1.571,1.586,1.600,1.663,1.767,2.001,2.010,2.141,2.240,2.398,2.527,2.652,2.781,2.831,2.944,3.120,3.205,3.209];
    const myr100_mg = [-1.967,-1.839,-1.710,-1.672,-1.569,-1.423,-1.325,-1.305,-1.186,-1.043,-1.042,-0.952,-0.852,-0.792,-0.770,-0.653,-0.566,-0.529,-0.394,-0.350,-0.261,-0.143,-0.085,0.020,0.062,0.081,0.201,0.271,0.413,0.485,0.569,0.705,0.721,0.937,1.051,1.183,1.307,1.313,1.381,1.450,1.520,1.525,1.593,1.668,1.746,1.827,1.914,2.005,2.102,2.130,2.208,2.323,2.447,2.471,2.578,2.721,2.869,3.029,3.195,3.374,3.564,3.766,3.978,4.201,4.365,4.443,4.691,4.720,4.815,5.226,5.518,5.837,5.847,6.186,6.569,7.041,7.045,7.368,7.406,7.442,7.586,7.818,8.397,8.420,8.764,9.015,9.468,9.862,10.231,10.602,10.736,11.019,11.384,11.565,11.572];
    const gyr1_bp_rp = [0.210,0.230,0.269,0.310,0.352,0.394,0.436,0.475,0.483,0.500,0.490,0.460,0.430,0.414,0.392,0.358,0.336,0.333,0.305,0.291,0.288,0.272,0.268,0.264,0.261,0.260,0.261,0.264,0.265,0.271,0.276,0.283,0.294,0.309,0.316,0.326,0.342,0.347,0.374,0.410,0.419,0.450,0.458,0.490,0.526,0.554,0.562,0.596,0.598,0.637,0.681,0.707,0.728,0.780,0.819,0.840,0.843,0.905,0.971,0.982,1.062,1.158,1.160,1.275,1.278,1.457,1.469,1.675,1.719,1.800,1.859,2.005,2.046,2.183,2.216,2.355,2.479,2.606,2.613,2.685,2.701,2.887];
    const gyr1_mg = [0.353,0.374,0.422,0.471,0.517,0.560,0.605,0.657,0.674,0.711,0.741,0.798,0.840,0.864,0.902,0.966,1.020,1.029,1.113,1.180,1.195,1.294,1.343,1.401,1.489,1.506,1.594,1.667,1.680,1.775,1.827,1.891,1.986,2.102,2.146,2.220,2.308,2.335,2.472,2.641,2.683,2.820,2.857,3.006,3.200,3.363,3.404,3.609,3.619,3.844,4.082,4.220,4.329,4.588,4.760,4.860,4.868,5.146,5.411,5.453,5.786,6.141,6.149,6.537,6.546,7.008,7.036,7.558,7.683,7.919,8.084,8.503,8.617,9.035,9.134,9.615,10.071,10.523,10.543,10.787,10.843,11.466];

    const traces = [
      {
        x: stripX, y: stripY,
        fill: 'toself',
        fillcolor: 'rgba(147, 112, 219, 0.15)',
        line: { color: 'rgba(147, 112, 219, 0.4)', width: 1, dash: 'dash' },
        name: 'Instability Strip',
        hoverinfo: 'name',
        mode: 'lines'
      },
      { x: myr100_bp_rp, y: myr100_mg, mode: 'lines', name: '100 Myr (PARSEC)', line: { color: '#000000', width: 1 } },
      { x: gyr1_bp_rp, y: gyr1_mg, mode: 'lines', name: '1 Gyr (PARSEC)', line: { color: '#000000', width: 1, dash: 'dot' } },
      { x: [0.874], y: [4.902], mode: 'markers', name: 'Sun', marker: { size: 12, color: '#000000', symbol: 'circle-open-dot', line: { color: '#000000', width: 2 } }, hovertemplate: '<b>Sun</b><br>BP-RP: 0.874<br>M_G: 4.902<extra></extra>' }
    ];

    if (bprp.length > 0) {
      traces.push({
        x: bprp, y: absG, mode: 'markers', name: 'Comoving',
        marker: {
          size: 10, color: voff, colorscale: 'Viridis', showscale: true,
          colorbar: { title: 'V<sub>off</sub>', len: 0.5, y: 0.75 },
          line: { color: '#333', width: 0.5 }
        },
        text: candidates.map(c => `Gaia DR3 ${c.source_id}`),
        hovertemplate: '<b>%{text}</b><br>BP-RP: %{x:.3f}<br>M_G: %{y:.2f}<extra></extra>'
      });
    }

    if (targetBpRp != null && targetAbsMag != null) {
      traces.push({
        x: [targetBpRp], y: [targetAbsMag],
        mode: 'markers',
        name: target._resolvedName || 'Target',
        marker: { size: 16, color: '#ef4444', symbol: 'star', line: { color: '#000', width: 2 } }
      });
    }

    const layout = {
      paper_bgcolor: '#ffffff', plot_bgcolor: '#ffffff',
      font: { color: '#1a1a2e', family: 'IBM Plex Sans', size: 12 },
      xaxis: { title: 'BP - RP (mag)', range: [-0.5, 3.5], dtick: 0.5, gridcolor: 'rgba(100,100,100,0.3)', zeroline: false },
      yaxis: { title: 'M<sub>G</sub> (mag)', range: [16, -4], dtick: 2, gridcolor: 'rgba(100,100,100,0.3)', zeroline: false },
      shapes: shapes,
      annotations: spectralTypeColors
        .filter(band => band.range[0] >= -0.5 && band.range[1] <= 3.5)
        .map(band => ({
          x: (band.range[0] + band.range[1]) / 2,
          y: -3,
          text: band.label,
          showarrow: false,
          font: { size: 14, color: 'rgba(0,0,0,0.5)', family: 'IBM Plex Sans', weight: 600 },
          xanchor: 'center',
          yanchor: 'bottom'
        })),
      legend: { x: 0.02, y: 0.02, bgcolor: 'rgba(255,255,255,0.9)', font: { size: 10 } },
      margin: { t: 20, r: 50, b: 50, l: 50 },
      hovermode: 'closest'
    };

    Plotly.newPlot(container, traces, layout, { responsive: true });
  }

  function downloadPlot() {
    Plotly.downloadImage('cmd-plot', {
      format: 'png',
      width: 400,
      height: 600,
      scale: 2,
      filename: `GaiaDR3_${targetData?.source_id}_CMD`
    });
  }

  async function discoverVizierTables(catalogPath) {
    const tapUrl = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';
    const query = `SELECT table_name FROM TAP_SCHEMA.tables WHERE schema_name = '${catalogPath}'`;

    const params = new URLSearchParams({
      REQUEST: 'doQuery',
      LANG: 'ADQL',
      FORMAT: 'json',
      QUERY: query
    });

    try {
      const response = await fetch(tapUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      });

      if (!response.ok) return [];

      const data = await response.json();
      if (!data.data) return [];

      return data.data.map(row => row[0]);
    } catch (e) {
      console.warn(`[Rotation] Could not discover tables for ${catalogPath}:`, e.message);
      return [];
    }
  }

  // =========================
  // Rotation periods (auto)
  // =========================
  async function searchRotationPeriods(ra, dec) {
      const results = [];
      const radiusDeg = 5 / 3600; // 5 arcsec
      let gaiaRotationIgnored = false;

      const ROTATION_CATALOGS = [
          // GCVS - General Catalogue of Variable Stars
          { name: 'GCVS', table: '"B/gcvs/gcvs_cat"', periodCol: 'Period',
            raCol: 'RAJ2000', decCol: 'DEJ2000' },

          // Gaia DR3 variability (keep ignoring by default due to accuracy issues)
          { name: 'Gaia DR3 Rotation', table: '"I/358/vrm"', periodCol: 'Freq',
            raCol: 'RA_ICRS', decCol: 'DE_ICRS', ignoreByDefault: true },

          // Bohigas+2020 - multi-table catalog
          { name: 'Bohigas+2020', catalog: 'J/other/RMxAA/56.139', tablePattern: /d$/, periodCol: 'Per',
            raCol: '_RAJ2000', decCol: '_DEJ2000', multiTable: true },

          // Angus+2018 - Kepler rotation periods
          { name: 'Angus+2018', table: '"J/MNRAS/474/2094/table5"', periodCol: 'Per',
            raCol: '_RA', decCol: '_DE' },

          // McQuillan+2013 - Kepler rotation periods
          { name: 'McQuillan+2013', table: '"J/ApJ/775/L11/table1"', periodCol: 'Prot',
            raCol: '_RA', decCol: '_DE' },

          // McQuillan+2014 - Kepler rotation periods
          { name: 'McQuillan+2014', table: '"J/ApJS/211/24/table1"', periodCol: 'Prot',
            raCol: '_RAJ2000', decCol: '_DEJ2000' },

          // Canto Martins+2020 - TESS TOI rotation
          { name: 'Canto Martins+2020', table: '"J/ApJS/250/20/table1"', periodCol: 'Prot',
            raCol: '_RAJ2000', decCol: '_DEJ2000' },

          // Rebull+2016 - Pleiades K2 rotation
          { name: 'Rebull+2016', table: '"J/AJ/152/113/table2"', periodCol: 'Prot',
            raCol: '_RAJ2000', decCol: '_DEJ2000' },

          // Reinhold & Hekker 2020 - K2 rotation
          { name: 'Reinhold+2020', table: '"J/A+A/635/A43/table2"', periodCol: 'Prot',
            raCol: '_RAJ2000', decCol: '_DEJ2000', ignoreByDefault: true },

          // Curtis+2019 - Pisces-Eridanus rotation
          { name: 'Curtis+2019', table: '"J/AJ/158/77/table2"', periodCol: 'Prot',
            raCol: '_RAJ2000', decCol: '_DEJ2000' },

          // Douglas+2017 - Praesepe K2 rotation
          { name: 'Douglas+2017', table: '"J/ApJ/842/83/table1"', periodCol: 'Prot',
            raCol: '_RAJ2000', decCol: '_DEJ2000' },
          { name: 'Douglas+2017', table: '"J/ApJ/842/83/table2"', periodCol: 'PCat',
            raCol: '_RAJ2000', decCol: '_DEJ2000' },
          { name: 'Douglas+2017', table: '"J/ApJ/842/83/table3"', periodCol: 'P',
            raCol: '_RAJ2000', decCol: '_DEJ2000' },

            // Colman+2024 - Pisces-Eridanus rotation
            { name: 'Colman+2024', table: '"J/AJ/167/189/fig12"', periodCol: 'Prot',
              raCol: '_RA', decCol: '_DE' },

            // Lin+2024 - Flares & flaring stars from TESS & machine learning
            { name: 'Lin+2024', table: '"J/AJ/168/234/table10"', periodCol: 'Prot',
              raCol: '_RAJ2000', decCol: '_DEJ2000' },

      ];

      const tapUrl = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';

      // Common coordinate column name patterns to try
      const coordPatterns = [
        { ra: 'RA_ICRS', dec: 'DE_ICRS' },
        { ra: 'RAJ2000', dec: 'DEJ2000' },
        { ra: 'RAdeg', dec: 'DEdeg' },
        { ra: 'RA', dec: 'DE' },
        { ra: 'ra', dec: 'dec' },
        { ra: '_RA', dec: '_DE' },
      ];

      // 1) Build flat list of all tables to query (expand multi-table catalogs)
      const tableQueries = [];
      for (const cat of ROTATION_CATALOGS) {
        if (cat.multiTable && cat.catalog && cat.tablePattern) {
          const allTables = await discoverVizierTables(cat.catalog);
          const matchingTables = allTables.filter(t => cat.tablePattern.test(t));
          console.log(`[Rotation] ${cat.name}: Found ${matchingTables.length} matching tables`);
          for (const t of matchingTables) {
            tableQueries.push({ ...cat, table: `"${cat.catalog}/${t}"` });
          }
        } else {
          tableQueries.push(cat);
        }
      }

      // 2) Query function for a single table
      async function queryRotationTable(cat) {
        const tableName = cat.table;
        try {
          console.log(`[Rotation] Querying ${cat.name} (${tableName})...`);

          // First, get the table schema to find coordinate columns
          const schemaQuery = `SELECT TOP 0 * FROM ${tableName}`;
          const schemaParams = new URLSearchParams({
            REQUEST: 'doQuery',
            LANG: 'ADQL',
            FORMAT: 'json',
            QUERY: schemaQuery
          });

          const schemaResp = await fetch(tapUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: schemaParams
          });

          if (!schemaResp.ok) {
            console.log(`[Rotation] ${cat.name}: Table not found in TAP`);
            return null;
          }

          const schemaData = await schemaResp.json();
          const cols = schemaData.metadata.map(m => m.name);

          // Find RA/Dec columns
          let raCol = null, decCol = null;
          for (const pattern of coordPatterns) {
            if (cols.some(c => c === pattern.ra) && cols.some(c => c === pattern.dec)) {
              raCol = pattern.ra;
              decCol = pattern.dec;
              break;
            }
          }

          // Try case-insensitive match
          if (!raCol) {
            const raMatch = cols.find(c => /^(ra|_ra|raj2000|ra_icrs|radeg)$/i.test(c));
            const decMatch = cols.find(c => /^(de|dec|_de|dej2000|de_icrs|dedeg)$/i.test(c));
            if (raMatch && decMatch) {
              raCol = raMatch;
              decCol = decMatch;
            }
          }

          if (!raCol || !decCol) {
            console.log(`[Rotation] ${cat.name}: Could not find RA/Dec columns`);
            return null;
          }

          // Now do the actual spatial query
          const query = `
            SELECT TOP 1 *
            FROM ${tableName}
            WHERE 1=CONTAINS(POINT('ICRS', ${raCol}, ${decCol}), CIRCLE('ICRS', ${ra}, ${dec}, ${radiusDeg}))
          `;

          const params = new URLSearchParams({
            REQUEST: 'doQuery',
            LANG: 'ADQL',
            FORMAT: 'json',
            QUERY: query
          });

          const response = await fetch(tapUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
          });

          if (!response.ok) {
            console.log(`[Rotation] ${cat.name}: Spatial query failed`);
            return null;
          }

          const data = await response.json();

          if (!data.data || data.data.length === 0) {
            console.log(`[Rotation] ${cat.name}: No match within 5"`);
            return null;
          }

          const row = data.data[0];
          console.log(`[Rotation] ${cat.name} MATCH FOUND!`);

          // Find period column
          let periodIdx = cols.findIndex(c => c.toLowerCase() === cat.periodCol.toLowerCase());
          if (periodIdx < 0) periodIdx = cols.findIndex(c => /^P(rot|er(iod)?)?$/i.test(c));
          if (periodIdx < 0) periodIdx = cols.findIndex(c => /period/i.test(c));

          if (periodIdx >= 0 && row[periodIdx] != null) {
            const period = parseFloat(row[periodIdx]);
            console.log(`[Rotation] ${cat.name}: Period = ${period} d`);

            if (!isNaN(period) && period > 0.1 && period < 200) {
              return { period, cat, tableName };
            }
          } else {
            console.log(`[Rotation] ${cat.name}: Period column not found or null`);
          }
          return null;
        } catch (err) {
          console.warn(`[Rotation] ${cat.name} (${tableName}) error:`, err.message);
          return null;
        }
      }

      // 3) Run ALL queries in parallel
      console.log(`[Rotation] Starting parallel search across ${tableQueries.length} tables...`);
      const queryResults = await Promise.allSettled(tableQueries.map(cat => queryRotationTable(cat)));

      // 4) Collect results
      for (const settled of queryResults) {
        if (settled.status !== 'fulfilled' || !settled.value) continue;

        const { period, cat, tableName } = settled.value;

        if (cat.ignoreByDefault) {
          gaiaRotationIgnored = true;
          console.log(`[Rotation] ${cat.name}: IGNORING due to accuracy issues`);
        } else {
          results.push({
            period,
            source: cat.name,
            catalog: tableName.replace(/"/g, '')
          });
        }
      }

      console.log(`[Rotation] Final results:`, results);
      return { results, gaiaRotationIgnored };
    }

    function displayRotationResults(rotData) {
        const container = document.getElementById('rotation-results');

        // Handle both old format (array) and new format (object with results and flag)
        const rotResults = Array.isArray(rotData) ? rotData : rotData.results;
        const gaiaIgnored = Array.isArray(rotData) ? false : rotData.gaiaRotationIgnored;

        let html = '';

        if (rotResults.length > 0) {
          html = rotResults.map(r => {
            const vizierUrl = `https://vizier.cds.unistra.fr/viz-bin/VizieR-3?-source=${encodeURIComponent(r.catalog)}`;
            return `
              <div class="youth-item">
                <span class="value prot-color">${r.period.toFixed(3)} d</span>
                <a href="${vizierUrl}" target="_blank" class="source">${r.source}</a>
              </div>
            `;
          }).join('');

          if (targetData?.teff_gspphot) {
            const periodsForPlot = rotResults.map(r => ({ value: r.period, source: r.source }));
            displayGyroPlot(targetData, periodsForPlot);
          }
        } else {
          html = '<div class="no-data">No rotation periods found</div>';
        }

        // Add note about ignored Gaia rotation data
        if (gaiaIgnored) {
          html += `
            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(251, 191, 36, 0.1); border-radius: 4px; font-size: 0.7rem; color: var(--text-muted);">
              <strong style="color: var(--warning);">Note:</strong> Gaia DR3 rotation period found but ignored due to known accuracy issues with that catalog.
            </div>
          `;
        }

        container.innerHTML = html;
      }
      function filterDistinctPeriods(rotationData, minDiff = 1.0) {
        if (!rotationData || rotationData.length === 0) return [];

        // Sort by period value
        const sorted = [...rotationData].sort((a, b) => a.value - b.value);

        // Keep periods that are >minDiff from all already-kept periods
        const kept = [sorted[0]];

        for (let i = 1; i < sorted.length; i++) {
          const isDifferentEnough = kept.every(k => Math.abs(sorted[i].value - k.value) > minDiff);
          if (isDifferentEnough) {
            kept.push(sorted[i]);
          }
        }

        return kept;
      }
  // =========================
  // Gyro plot
  // =========================
  function displayGyroPlot(target, rotationData) {
    const container = document.getElementById('gyro-plot');
    const panel = document.getElementById('gyro-panel');

    // Handle both single period (number) and array of periods
    let periods = [];
    if (typeof rotationData === 'number') {
      periods = [{ value: rotationData, source: 'Unknown' }];
    } else if (Array.isArray(rotationData)) {
      periods = filterDistinctPeriods(rotationData, 1.0);
    }

    if (!target.teff_gspphot || periods.length === 0) {
      panel.style.display = 'none';
      return;
    }

    panel.style.display = 'block';

    const traces = [];
    const hexToRgba = (hex, alpha) => {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    };

    // Plot cluster sequences
    Object.entries(gyroClusterData).forEach(([key, cluster]) => {
      const teff = cluster.teff.slice();
      const prot = cluster.prot.slice();
      const scatter = cluster.scatter.slice();

      traces.push({ x: teff, y: prot.map((p, i) => p + scatter[i]), mode: 'lines', line: { color: 'transparent' }, showlegend: false, hoverinfo: 'skip' });
      traces.push({ x: teff, y: prot.map((p, i) => Math.max(0, p - scatter[i])), mode: 'lines', fill: 'tonexty', fillcolor: hexToRgba(cluster.color, 0.2), line: { color: 'transparent' }, showlegend: false, hoverinfo: 'skip' });
      traces.push({ x: teff, y: prot, mode: 'lines', name: cluster.label, line: { color: cluster.color, width: 2.5 } });
    });

    // Plot each distinct rotation period
    const markerColors = ['#ef4444', '#22d3ee', '#a78bfa', '#4ade80', '#fb923c'];
    const markerSymbols = ['star', 'star', 'star', 'star', 'star'];

    periods.forEach((p, i) => {
      const color = markerColors[i % markerColors.length];
      const symbol = markerSymbols[i % markerSymbols.length];
      const label = p.source || `Period ${i + 1}`;

      traces.push({
        x: [target.teff_gspphot],
        y: [p.value],
        mode: 'markers',
        name: `${p.value.toFixed(2)} d (${label})`,
        marker: { size: 14, symbol: symbol, color: color, line: { color: '#000', width: 1 } },
        hovertemplate: `<b>${target._resolvedName || 'Target'}</b><br>Teff=${Math.round(target.teff_gspphot)} K<br>Prot=${p.value.toFixed(3)} d<br>Source: ${label}<extra></extra>`
      });
    });

    const layout = {
      paper_bgcolor: '#ffffff',
      plot_bgcolor: '#ffffff',
      font: { color: '#1a1a2e', family: 'IBM Plex Sans' },
      xaxis: {
        title: 'T<sub>eff</sub> (K)',
        autorange: 'reversed',
        gridcolor: 'rgba(100,100,100,0.2)',
        zeroline: false
      },
      yaxis: {
        title: 'P<sub>rot</sub> (days)',
        gridcolor: 'rgba(100,100,100,0.2)',
        zeroline: false
      },
      legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)', bordercolor: 'rgba(0,0,0,0.1)', borderwidth: 1, font: { size: 10 } },
      margin: { t: 20, r: 20, b: 50, l: 60 },
      hovermode: 'closest'
    };

    Plotly.newPlot(container, traces, layout, { responsive: true });
  }

  // =========================
  // Toomre (kept minimal: only shows if RV exists)
  // =========================
  function computeUVW(ra, dec, pmra, pmdec, parallax, rv) {
    const U_sun = 11.1, V_sun = 12.24, W_sun = 7.25;

    const alpha = deg2rad(ra);
    const delta = deg2rad(dec);

    const dist = 1000 / parallax;

    const k = 4.74047 / 1000;
    const vra = k * pmra * dist;
    const vdec = k * pmdec * dist;

    const T11 = -0.0548755604, T12 = -0.8734370902, T13 = -0.4838350155;
    const T21 = +0.4941094279, T22 = -0.4448296300, T23 = +0.7469822445;
    const T31 = -0.8676661490, T32 = -0.1980763734, T33 = +0.4559837762;

    const cosra = Math.cos(alpha), sinra = Math.sin(alpha);
    const cosdec = Math.cos(delta), sindec = Math.sin(delta);

    const A11 = -sinra;
    const A12 = -sindec * cosra;
    const A13 = cosdec * cosra;
    const A21 = cosra;
    const A22 = -sindec * sinra;
    const A23 = cosdec * sinra;
    const A31 = 0;
    const A32 = cosdec;
    const A33 = sindec;

    const B11 = T11*A11 + T12*A21 + T13*A31;
    const B12 = T11*A12 + T12*A22 + T13*A32;
    const B13 = T11*A13 + T12*A23 + T13*A33;
    const B21 = T21*A11 + T22*A21 + T23*A31;
    const B22 = T21*A12 + T22*A22 + T23*A32;
    const B23 = T21*A13 + T22*A23 + T23*A33;
    const B31 = T31*A11 + T32*A21 + T33*A31;
    const B32 = T31*A12 + T32*A22 + T33*A32;
    const B33 = T31*A13 + T32*A23 + T33*A33;

    const U_helio = B11*vra + B12*vdec + B13*rv;
    const V_helio = B21*vra + B22*vdec + B23*rv;
    const W_helio = B31*vra + B32*vdec + B33*rv;

    return { U: U_helio + U_sun, V: V_helio + V_sun, W: W_helio + W_sun };
  }

  function displayToomreDiagram(target) {
    const panel = document.getElementById('toomre-panel');
    if (!target.radial_velocity || !target.pmra || !target.pmdec || !target.parallax) { panel.style.display = 'none'; return; }

    const uvw = computeUVW(target.ra, target.dec, target.pmra, target.pmdec, target.parallax, target.radial_velocity);
    if ([uvw.U, uvw.V, uvw.W].some(x => !isFinite(x))) { panel.style.display = 'none'; return; }

    panel.style.display = 'block';
    const container = document.getElementById('toomre-plot');

    const UW = Math.sqrt(uvw.U*uvw.U + uvw.W*uvw.W);
    const vtot = Math.sqrt(uvw.U*uvw.U + uvw.V*uvw.V + uvw.W*uvw.W);

    const traces = [];

    // Thin disk region
    const thinDiskX = [], thinDiskY = [];
    for (let a = 0; a <= Math.PI; a += 0.02) {
      thinDiskX.push(-85 * Math.cos(a));
      thinDiskY.push(85 * Math.sin(a));
    }
    thinDiskX.push(85, -85);
    thinDiskY.push(0, 0);

    traces.push({
      x: thinDiskX, y: thinDiskY,
      fill: 'toself',
      fillcolor: 'rgba(34, 197, 94, 0.15)',
      line: { color: 'rgba(34, 197, 94, 0.4)', width: 1.5, dash: 'dash' },
      mode: 'lines',
      name: 'Thin disk',
      hoverinfo: 'name',
      showlegend: true
    });

    [100, 180].forEach(r => {
      const xpts = [], ypts = [];
      for (let a = 0; a <= Math.PI; a += 0.05) {
        xpts.push(-r * Math.cos(a));
        ypts.push(r * Math.sin(a));
      }
      traces.push({ x: xpts, y: ypts, mode: 'lines', line: { color: 'rgba(80,80,80,0.5)', width: 1, dash: 'dash' }, hoverinfo: 'skip', showlegend: false });
    });

    traces.push({
      x: [uvw.V], y: [UW],
      mode: 'markers',
      name: target._resolvedName || 'Target',
      marker: { size: 14, color: '#ef4444', symbol: 'star', line: { color: '#000', width: 1 } },
      hovertemplate: `<b>${target._resolvedName || 'Target'}</b><br>U=${uvw.U.toFixed(1)}<br>V=${uvw.V.toFixed(1)}<br>W=${uvw.W.toFixed(1)}<br>v_tot=${vtot.toFixed(1)}<extra></extra>`
    });

    // Sun's peculiar motion relative to LSR
    const sunUW = Math.sqrt(11.1*11.1 + 7.25*7.25); // ‚âà 13.26 km/s
    traces.push({
      x: [12.24], y: [sunUW],
      mode: 'markers',
      name: 'Sun',
      marker: { size: 14, color: '#eab308', symbol: 'circle-open-dot', line: { color: '#000', width: 2 } },
      hovertemplate: '<b>Sun</b><br>U=11.1<br>V=12.24<br>W=7.25<br>v_tot=18.0<extra></extra>'
    });

    const xMin = Math.min(-160, uvw.V - 20);
    const xMax = Math.max(60, uvw.V + 20);
    const yMax = Math.max(160, UW + 20);

    const layout = {
      paper_bgcolor: '#ffffff',
      plot_bgcolor: '#ffffff',
      font: { color: '#1a1a2e', family: 'IBM Plex Sans' },
      xaxis: { title: 'V [km/s]', range: [xMin, xMax], gridcolor: 'rgba(100,100,100,0.2)', zerolinecolor: 'rgba(100,100,100,0.3)', dtick: 50 },
      yaxis: { title: '(U¬≤ + W¬≤)^¬Ω [km/s]', range: [0, yMax], gridcolor: 'rgba(100,100,100,0.2)', dtick: 50 },
      showlegend: true,
      legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.8)', bordercolor: 'rgba(0,0,0,0.1)', borderwidth: 1, font: { size: 10 } },
      margin: { t: 20, r: 20, b: 50, l: 60 }
    };

    Plotly.newPlot(container, traces, layout, { responsive: true });
  }

  function downloadToomrePlot() {
    Plotly.downloadImage('toomre-plot', {
      format: 'png',
      width: 400,
      height: 300,
      scale: 2,
      filename: `GaiaDR3_${targetData?.source_id}_toomre`
    });
  }

  function downloadTeqPlot() {
    const plotArea = document.getElementById('teq-plot-area');
    if (!plotArea || !plotArea.data) {
      console.error('Teq plot not found or not rendered');
      return;
    }

    Plotly.downloadImage(plotArea, {
      format: 'png',
      width: 600,
      height: 400,
      scale: 3,
      filename: `GaiaDR3_${targetData?.source_id || 'target'}_teq`
    });
  }

  // =========================
  // Youth indicators (kept from your v2.1; shortened here to avoid altering behavior)
  // =========================
  function vizierLink(catalog, source) {
      if (!catalog) return `<span class="source">${source}</span>`;
      const vizierUrl = `https://vizier.cds.unistra.fr/viz-bin/VizieR-3?-source=${encodeURIComponent(catalog)}`;
      return `<a href="${vizierUrl}" target="_blank" class="source">${source}</a>`;
    }

  function getManualYouthData(targetData) {
    const results = { ewli: [], prot: [], rhk: [], lx: [] };
    if (!targetData?._resolvedName) return results;

    const name = targetData._resolvedName;
    let entry = manualYouthData[name];

    if (!entry) {
      const normalized = name.replace(/[-\s]+/g, '-').toUpperCase();
      const key = Object.keys(manualYouthData).find(k => k.replace(/[-\s]+/g, '-').toUpperCase() === normalized);
      if (key) entry = manualYouthData[key];
    }
    if (entry?.aliasOf) entry = manualYouthData[entry.aliasOf];

    if (entry) {
      ['ewli', 'prot', 'rhk', 'lx'].forEach(type => { if (entry[type]) results[type].push(...entry[type]); });
    }
    return results;
  }

  async function queryVizierYouthIndicators(ra, dec) {
    const results = {
      ewli: [],
      prot: [],
      rhk: [],
      lx: [],
      protMeta: { gaiaRotationIgnored: false }
    };

    const radius = 5 / 3600;

    async function queryVizierCatalog(catalog, label) {
      const url = `https://vizier.cds.unistra.fr/viz-bin/conesearch/${catalog}?RA=${ra}&DEC=${dec}&SR=${radius}&VERB=3`;
      try {
        const response = await fetch(url);
        if (!response.ok) return null;

        const text = await response.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');

        const fields = xml.querySelectorAll('FIELD');
        const metadata = Array.from(fields).map(f => ({ name: f.getAttribute('name') || f.getAttribute('ID') }));

        const trs = xml.querySelectorAll('TABLEDATA TR');
        if (trs.length === 0) return null;

        const rows = Array.from(trs).map(tr =>
          Array.from(tr.querySelectorAll('TD')).map(td => {
            const val = td.textContent.trim();
            const num = parseFloat(val);
            return isNaN(num) ? val : num;
          })
        );

        return { metadata, rows, label };
      } catch {
        return null;
      }
    }

    function findColumnValue(metadata, row, patterns) {
      for (const pattern of patterns) {
        const regex = new RegExp(pattern, 'i');
        const colIdx = metadata.findIndex(m => regex.test(m.name));
        if (colIdx >= 0 && row[colIdx] != null) {
          const val = parseFloat(row[colIdx]);
          if (!isNaN(val)) return { value: val, colName: metadata[colIdx].name };
        }
      }
      return null;
    }

    // NOTE: prot catalogs removed here to avoid double-search and overwrites.
    const catalogs = [
      { catalog: 'J/A+A/504/829/cbssb', label: 'Guillout+2009', type: 'li' },
      { catalog: 'J/A+A/664/A78/gaia3', label: 'GALAH DR3', type: 'li' },
      { catalog: 'J/A+A/616/A10/tablea1', label: 'Gaia-ESO DR3', type: 'li' },
      { catalog: 'J/ApJ/756/24/table2', label: 'Scholz+2012', type: 'li' },
      { catalog: 'J/A+A/576/A69/table2', label: 'Delgado Mena+2015', type: 'li' },
      { catalog: 'J/A+A/614/A55/table3', label: 'Aguilera-Gomez+2018', type: 'li' },
      { catalog: 'J/AJ/153/21/table5', label: 'Luck+2016', type: 'li' },
      { catalog: 'J/ApJ/756/46/table3', label: 'Ramirez+, 2012', type: 'li' },

      { catalog: 'J/A+A/551/L8/cacomp', label: 'Pace+2013', type: 'rhk' },
      { catalog: 'J/A+A/450/993/tablea1', label: 'Wright+2004', type: 'rhk' },
      { catalog: 'J/A+A/450/993/tableb1', label: 'Wright+2004', type: 'rhk' },
      { catalog: 'J/A+A/450/993/tablec1', label: 'Wright+2004', type: 'rhk' },
      { catalog: 'J/A+A/616/A108/catalog', label: 'Boro Saikia+2018', type: 'rhk' },

      { catalog: 'J/A+A/450/993/table2', label: 'NEXXUS', type: 'lx' },
      { catalog: 'J/ApJS/262/14/catalog', label: 'Freund+2022', type: 'lx' },
    ];

    const ewLiPatterns = ['^EWLi$', '^EW_?Li', '^EW$', 'LiEW', 'EW\\(Li\\)'];
    const aLiPatterns = ['^A_?Li', '^ALi$', '^A\\(Li\\)$', '^Li$', 'Lith'];
    const rhkPatterns = ['logR.*HK', 'log_?R.*HK', "logR'HK", 'RHK', 'logRMW'];
    const lxPatterns  = ['^Lx$', '^L_?[Xx]', '^logLx', 'LX',];

    // 1) Rotation periods (TAP) ‚Äî now part of the same pipeline
    try {
      const rotData = await searchRotationPeriods(ra, dec); // returns {results, gaiaRotationIgnored}
      results.protMeta.gaiaRotationIgnored = !!rotData?.gaiaRotationIgnored;

      const rotResults = rotData?.results || [];
      // Convert to the same shape used elsewhere: {value, source, catalog}
      results.prot = rotResults.map(r => ({
        value: r.period,
        source: r.source,
        catalog: r.catalog
      }));
    } catch (e) {
      console.warn('[Youth] rotation TAP query failed:', e);
    }

    // 2) Other youth indicators via conesearch (Li, R'HK, Lx) - PARALLEL
    const catalogPromises = catalogs.map(async (cat) => {
      const result = await queryVizierCatalog(cat.catalog, cat.label);
      return { cat, result };
    });

    const catalogResults = await Promise.allSettled(catalogPromises);

    for (const settled of catalogResults) {
      if (settled.status !== 'fulfilled' || !settled.value.result) continue;

      const { cat, result } = settled.value;
      const { metadata, rows, label } = result;
      const row = rows[0];

      if (cat.type === 'li') {
        // Try EW(Li) first (in m√Ö, typically 0-500)
        let found = findColumnValue(metadata, row, ewLiPatterns);
        if (found && found.value > 0 && found.value < 500) {
          results.ewli.push({ value: found.value, source: label, catalog: cat.catalog, isALi: false });
        } else {
          // Try A(Li) (in dex, typically 0-4)
          found = findColumnValue(metadata, row, aLiPatterns);
          if (found && found.value > -1 && found.value < 5) {
            results.ewli.push({ value: found.value, source: label, catalog: cat.catalog, isALi: true });
          }
        }
      } else if (cat.type === 'rhk') {
        const found = findColumnValue(metadata, row, rhkPatterns);
        if (found) {
          let val = found.value;
          if (val > 0) val = -val;
          if (val < -3 && val > -6) results.rhk.push({ value: val, source: label, catalog: cat.catalog });
        }
      } else if (cat.type === 'lx') {
        const found = findColumnValue(metadata, row, lxPatterns);
        if (found) {
          let val = found.value;
          const isLog = found.colName.toLowerCase().includes('log');
          if (!isLog && val > 100) val = Math.log10(val);
          if (val > 25 && val < 35) results.lx.push({ value: val, source: label, catalog: cat.catalog, isLog: true });
        }
      }
    }

    return results;
  }

  function displayYouthIndicators(data) {
    const manualData = getManualYouthData(targetData);
    const mergedData = {
      ewli: [...manualData.ewli, ...data.ewli],
      prot: [...manualData.prot, ...data.prot],
      rhk: [...manualData.rhk, ...data.rhk],
      lx: [...manualData.lx, ...data.lx]
    };

    const liHTML = mergedData.ewli.length > 0 ? mergedData.ewli.map(m => {
      const errorStr = m.error ? ` ¬± ${m.error.toFixed(m.isALi ? 2 : 0)}` : '';
      const sourceLink = m.url ? `<a href="${m.url}" target="_blank" class="source">${m.source}</a>` : vizierLink(m.catalog, m.source);
      if (m.isALi) {
        return `<div class="youth-item"><span class="value li-color">A(Li) = ${m.value.toFixed(2)}${errorStr} dex</span>${sourceLink}</div>`;
      } else {
        return `<div class="youth-item"><span class="value li-color">EW(Li) = ${m.value.toFixed(1)}${errorStr} m√Ö</span>${sourceLink}</div>`;
      }
    }).join('') : '<div class="no-data">No measurements found</div>';
    document.getElementById('li-values').innerHTML = liHTML;

    const rotHTML = mergedData.prot.length > 0
      ? mergedData.prot.map(m => `
          <div class="youth-item">
            <span class="value prot-color">${m.value.toFixed(3)} d</span>
            ${m.url ? `<a href="${m.url}" target="_blank" class="source">${m.source}</a>` : vizierLink(m.catalog, m.source)}
          </div>
        `).join('')
      : '<div class="no-data">No measurements found</div>';

    // Append Gaia-ignored note if applicable
    const gaiaIgnored = !!data?.protMeta?.gaiaRotationIgnored;
    const ignoredNote = gaiaIgnored ? `
      <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(251, 191, 36, 0.1); border-radius: 4px; font-size: 0.7rem; color: var(--text-muted);">
        <strong style="color: var(--warning);">Note:</strong> Gaia DR3 rotation period found but ignored due to known accuracy issues with that catalog.
      </div>
    ` : '';

    document.getElementById('rotation-results').innerHTML = rotHTML + ignoredNote;

    // Gyro plot: show all distinct periods
    if (mergedData.prot.length > 0 && targetData?.teff_gspphot) {
      displayGyroPlot(targetData, mergedData.prot);
    } else {
      document.getElementById('gyro-panel').style.display = 'none';
    }

    const rhkHTML = mergedData.rhk.length > 0 ? mergedData.rhk.map(m => `
      <div class="youth-item">
        <span class="value rhk-color">${m.value.toFixed(3)}</span>
        ${m.url ? `<a href="${m.url}" target="_blank" class="source">${m.source}</a>` : vizierLink(m.catalog, m.source)}
      </div>
    `).join('') : '<div class="no-data">No measurements found</div>';
    document.getElementById('rhk-results').innerHTML = rhkHTML;

    const lxHTML = mergedData.lx.length > 0 ? mergedData.lx.map(m => `
      <div class="youth-item">
        <span class="value lx-color">${m.value.toFixed(2)}</span>
        ${m.url ? `<a href="${m.url}" target="_blank" class="source">${m.source}</a>` : vizierLink(m.catalog, m.source)}
      </div>
    `).join('') : '<div class="no-data">No measurements found</div>';
    document.getElementById('lx-results').innerHTML = lxHTML;
  }

  async function searchYouthIndicators() {
    if (!targetData) return;

    document.getElementById('li-values').innerHTML = '<div class="no-data">Searching...</div>';
    document.getElementById('rotation-results').innerHTML = '<div class="no-data">Searching...</div>';
    document.getElementById('rhk-results').innerHTML = '<div class="no-data">Searching...</div>';
    document.getElementById('lx-results').innerHTML = '<div class="no-data">Searching...</div>';
    document.getElementById('gyro-panel').style.display = 'none';

    const btn = document.getElementById('btn-youth');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Searching...';

    try {
      vizierYouthData = await queryVizierYouthIndicators(targetData.ra, targetData.dec);
      displayYouthIndicators(vizierYouthData);
    } catch (e) {
      console.error('Youth indicator search error:', e);
    } finally {
      btn.disabled = false;
      btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"></path></svg> Youth Indicators`;
    }
  }

  // =========================
  // TESS + Exoplanet Archive (kept from your v2.1; unchanged logic)
  // =========================
  function updateTargetInfoWithTIC(ticId) {
    const container = document.getElementById('target-info');
    const existingTIC = container.querySelector('[data-field="tic"]');
    if (!existingTIC && ticId) {
      const ticItem = document.createElement('div');
      ticItem.className = 'info-item';
      ticItem.setAttribute('data-field', 'tic');
      ticItem.innerHTML = `<div class="label">TIC ID</div><div class="value highlight">${ticId}</div>`;
      container.appendChild(ticItem);
    }
  }

  async function searchTESSSectors() {
      if (!targetData) return;

      const btn = document.getElementById('btn-tess');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Searching...';

      const container = document.getElementById('tess-info-container');

      try {
        const ra = targetData.ra;
        const dec = targetData.dec;

        let ticId = null;
        let tmag = null;

        // Use TAP endpoint (same as Gaia queries) instead of conesearch
        try {
          const tapUrl = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';
          const radiusDeg = 5 / 3600; // 5 arcsec

          // Query TIC v8.2 catalog via TAP
          const query = `
            SELECT TOP 1 TIC, Tmag, RAJ2000, DEJ2000,
                   DISTANCE(POINT('ICRS', RAJ2000, DEJ2000), POINT('ICRS', ${ra}, ${dec})) AS dist
            FROM "IV/39/tic82"
            WHERE 1=CONTAINS(POINT('ICRS', RAJ2000, DEJ2000), CIRCLE('ICRS', ${ra}, ${dec}, ${radiusDeg}))
            ORDER BY dist ASC
          `;

          console.log('TIC TAP query:', query);

          const params = new URLSearchParams({
            REQUEST: 'doQuery',
            LANG: 'ADQL',
            FORMAT: 'json',
            QUERY: query
          });

          const response = await fetch(tapUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
          });

          if (response.ok) {
            const data = await response.json();
            console.log('TIC TAP response:', data);

            if (data.data && data.data.length > 0) {
              const cols = data.metadata.map(m => m.name);
              const row = data.data[0];

              const ticIdx = cols.findIndex(c => /^TIC$/i.test(c));
              const tmagIdx = cols.findIndex(c => /^Tmag$/i.test(c));

              console.log('Columns:', cols);
              console.log('Row:', row);

              if (ticIdx >= 0) {
                ticId = String(row[ticIdx]);
                tmag = tmagIdx >= 0 ? parseFloat(row[tmagIdx]) : null;
                console.log('Found TIC:', ticId, 'Tmag:', tmag);
              }
            }
          }
        } catch (e) {
          console.warn('TIC TAP query failed:', e);
        }

        // Fallback: Try TIC v8.0 if v8.2 failed
        if (!ticId) {
          try {
            const tapUrl = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';
            const radiusDeg = 5 / 3600;

            const query = `
              SELECT TOP 1 TIC, Tmag, RAJ2000, DEJ2000,
                     DISTANCE(POINT('ICRS', RAJ2000, DEJ2000), POINT('ICRS', ${ra}, ${dec})) AS dist
              FROM "IV/38/tic"
              WHERE 1=CONTAINS(POINT('ICRS', RAJ2000, DEJ2000), CIRCLE('ICRS', ${ra}, ${dec}, ${radiusDeg}))
              ORDER BY dist ASC
            `;

            console.log('TIC v8.0 TAP query:', query);

            const params = new URLSearchParams({
              REQUEST: 'doQuery',
              LANG: 'ADQL',
              FORMAT: 'json',
              QUERY: query
            });

            const response = await fetch(tapUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: params
            });

            if (response.ok) {
              const data = await response.json();
              console.log('TIC v8.0 TAP response:', data);

              if (data.data && data.data.length > 0) {
                const cols = data.metadata.map(m => m.name);
                const row = data.data[0];

                const ticIdx = cols.findIndex(c => /^TIC$/i.test(c));
                const tmagIdx = cols.findIndex(c => /^Tmag$/i.test(c));

                if (ticIdx >= 0) {
                  ticId = String(row[ticIdx]);
                  tmag = tmagIdx >= 0 ? parseFloat(row[tmagIdx]) : null;
                  console.log('Found TIC v8.0:', ticId, 'Tmag:', tmag);
                }
              }
            }
          } catch (e) {
            console.warn('TIC v8.0 TAP query failed:', e);
          }
        }

        if (ticId) {
          ticInfo = { tic: ticId, tmag };
          updateTargetInfoWithTIC(ticId);
        }

        // Search for TESS sectors via MAST
        let sectors = [];
        try {
          const mastRequest = {
            service: "Mast.Caom.Cone",
            params: { ra, dec, radius: 0.001 },
            format: "json",
            pagesize: 500
          };

          const mastUrl = 'https://mast.stsci.edu/api/v0/invoke';
          const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(mastUrl)}`;

          const obsResp = await fetch(proxyUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'request=' + encodeURIComponent(JSON.stringify(mastRequest))
          });

          if (obsResp.ok) {
            const obsData = await obsResp.json();
            if (obsData.data && obsData.data.length > 0) {
              const tessObs = obsData.data.filter(obs =>
                obs.obs_collection === 'TESS' || (obs.project && obs.project.includes('TESS'))
              );

              const sectorSet = new Set();
              for (const obs of tessObs) {
                const obsId = obs.obs_id || '';
                const seqNum = obs.sequence_number;

                const sectorMatch = obsId.match(/tess.*?-s(\d{4})/i) ||
                  obsId.match(/tess.*?sector(\d+)/i) ||
                  obsId.match(/-s(\d+)-/i);
                if (sectorMatch) sectorSet.add(parseInt(sectorMatch[1]));
                if (seqNum && seqNum > 0 && seqNum < 100) sectorSet.add(seqNum);
              }
              sectors = Array.from(sectorSet).filter(s => s > 0 && s < 100).sort((a, b) => a - b);
            }
          }
        } catch (e) {
          console.warn('MAST observations query failed:', e);
        }

        // Fallback sector search via TESScut
        if (sectors.length === 0) {
          try {
            const tessecutUrl = `https://mast.stsci.edu/tesscut/api/v0.1/sector?ra=${ra}&dec=${dec}`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(tessecutUrl)}`;

            const sectResp = await fetch(proxyUrl);
            if (sectResp.ok) {
              const sectData = await sectResp.json();
              if (sectData.results && sectData.results.length > 0) {
                sectors = sectData.results.map(r => r.sector).filter(s => s > 0).sort((a, b) => a - b);
              }
            }
          } catch (e) {
            console.warn('TESScut query failed:', e);
          }
        }

        if (ticInfo) ticInfo.sectors = sectors;

        // Build display HTML
        let html = `<div class="tess-info"><div class="tess-info-header">TESS Information</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; font-size:0.85rem;">`;

        if (ticId) {
          html += `<div><span style="color:var(--text-muted);">TIC ID:</span>
            <a href="https://exofop.ipac.caltech.edu/tess/target.php?id=${ticId}" target="_blank"
               style="color:var(--accent-cyan); font-family:'IBM Plex Mono', monospace;">${ticId}</a></div>
            <div><span style="color:var(--text-muted);">T mag:</span> ${tmag?.toFixed(2) || 'N/A'}</div>`;
        } else {
          html += `<div style="grid-column:1 / -1; color:var(--text-muted);">No TIC match found within 5"</div>`;
        }
        html += `</div>`;

        if (sectors.length > 0) {
          html += `<div style="margin-top:0.5rem; font-size:0.85rem;">
            <span style="color:var(--text-muted);">Observed Sectors (${sectors.length}):</span><br>
            <span style="font-family:'IBM Plex Mono', monospace; color:var(--accent-blue);">${sectors.join(', ')}</span>
          </div>`;
        } else {
          html += `<div style="margin-top:0.5rem; font-size:0.85rem;">
            <span style="color:var(--text-muted);">Sectors:</span>
            <a href="https://heasarc.gsfc.nasa.gov/wsgi-scripts/TESS/TESS-point_Web_Tool/TESS-point_Web_Tool/wtv_v2.0.py/?ra=${ra}&dec=${dec}" target="_blank"
               style="color:var(--accent-cyan); margin-left:0.5rem;">Check TESS-point ‚Üí</a>
          </div>`;
        }

        html += `</div>`;
        container.innerHTML = html;

      } catch (e) {
        console.error('TESS search error:', e);
        container.innerHTML = `<div class="tess-info"><div class="tess-info-header">TESS Information</div><p style="color: var(--error);">Error: ${e.message}</p></div>`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg> TESS Sectors`;
      }
    }

    async function checkExoplanetArchive() {
      if (!targetData) return;

      const btn = document.getElementById('btn-exoplanet');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Checking...';

      const container = document.getElementById('exoplanet-alert');

      // Fetch with timeout and proxy fallback
            async function fetchWithTimeout(url, timeoutMs = 8000) {
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

              try {
                const resp = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (resp.ok) return await resp.json();
              } catch (e) {
                clearTimeout(timeoutId);
                if (e.name === 'AbortError') {
                  console.log('[Exoplanet] Direct fetch timed out, trying proxy...');
                }
              }

              // Try CORS proxy with shorter timeout
              try {
                const proxyController = new AbortController();
                const proxyTimeoutId = setTimeout(() => proxyController.abort(), 6000);
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const resp = await fetch(proxyUrl, { signal: proxyController.signal });
                clearTimeout(proxyTimeoutId);
                if (resp.ok) return await resp.json();
              } catch (e) {
                console.log('[Exoplanet] Proxy fetch failed:', e.message);
              }

              return null;
            }

            try {
              let data = [];
              const selectFields = 'hostname,pl_name,pl_rade,pl_bmasse,pl_orbper,pl_orbsmax,st_rad,st_teff,disc_year';

              // Try coordinate search FIRST (usually faster)
              if (targetData.ra && targetData.dec) {
                console.log('[Exoplanet] Trying coordinate search...');
                const url = `https://exoplanetarchive.ipac.caltech.edu/TAP/sync?query=SELECT+${selectFields}+FROM+pscomppars+WHERE+1=CONTAINS(POINT('ICRS',ra,dec),CIRCLE('ICRS',${targetData.ra},${targetData.dec},${5/3600}))&format=json`;
                const result = await fetchWithTimeout(url);
                if (result && result.length > 0) data = result;
              }

              // Fallback to Gaia ID if coordinate search failed
              if (data.length === 0 && targetData.source_id) {
                console.log('[Exoplanet] Trying Gaia ID search...');
                const url = `https://exoplanetarchive.ipac.caltech.edu/TAP/sync?query=SELECT+${selectFields}+FROM+pscomppars+WHERE+gaia_id='Gaia+DR3+${targetData.source_id}'&format=json`;
                const result = await fetchWithTimeout(url);
                if (result && result.length > 0) data = result;
              }

              if (data && data.length > 0) {
          const uniquePlanetNames = [...new Set(data.map(p => p.pl_name))];
          const uniquePlanets = uniquePlanetNames.map(name => data.find(pl => pl.pl_name === name));
          uniquePlanets.sort((a, b) => {
            if (a.pl_orbper == null && b.pl_orbper == null) return 0;
            if (a.pl_orbper == null) return 1;
            if (b.pl_orbper == null) return -1;
            return a.pl_orbper - b.pl_orbper;
          });

          const hostname = data[0].hostname;
          const st_rad = data[0].st_rad;
          const st_teff = data[0].st_teff;

          exoplanetData = { hostname, st_rad, st_teff, planets: uniquePlanets };

          // Check if any planet can be plotted
          const plottablePlanets = uniquePlanets.filter(p => p.pl_orbsmax && p.pl_rade);

          let html = `
                      <div class="exoplanet-alert">
                        <div class="exoplanet-alert-header" onclick="toggleExoplanetDetails()" style="cursor:pointer; user-select:none;">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          Confirmed Exoplanet Host: ${hostname}
                          <svg id="exoplanet-toggle-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:auto; transition:transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"></polyline>
                          </svg>
                        </div>
                        <div id="exoplanet-details">
                          <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.5rem;">
                            T<sub>eff</sub> = ${st_teff ? st_teff.toFixed(0) + ' K' : 'N/A'} |
                            R<sub>‚òÖ</sub> = ${st_rad ? st_rad.toFixed(3) + ' R‚òâ' : 'N/A'}
                          </div>
                          <table style="width:100%; font-size:0.7rem; font-family:'IBM Plex Mono',monospace; border-collapse:collapse;">
                            <tr style="color:var(--text-muted); border-bottom:1px solid var(--border-color);">
                              <th style="text-align:left; padding:0.25rem;">Planet</th>
                              <th style="text-align:right; padding:0.25rem;">Period</th>
                              <th style="text-align:right; padding:0.25rem;">Sep</th>
                              <th style="text-align:right; padding:0.25rem;">Radius</th>
                            </tr>
                    `;

                    uniquePlanets.forEach(p => {
                      html += `
                        <tr style="border-bottom:1px solid var(--border-color);">
                          <td style="padding:0.25rem; color:var(--text-primary);">${p.pl_name}</td>
                          <td style="text-align:right; padding:0.25rem; color:var(--accent-cyan);">${p.pl_orbper ? p.pl_orbper.toFixed(2) + ' d' : 'N/A'}</td>
                          <td style="text-align:right; padding:0.25rem; color:var(--accent-cyan);">${p.pl_orbsmax ? p.pl_orbsmax.toFixed(3) + ' AU' : 'N/A'}</td>
                          <td style="text-align:right; padding:0.25rem; color:var(--accent-cyan);">${p.pl_rade ? p.pl_rade.toFixed(2) + ' R‚äï' : 'N/A'}</td>
                        </tr>
                      `;
                    });

                    html += `</table>`;

                    if (plottablePlanets.length > 0) {
                      html += `
                        <button onclick="showTeqPlot()" style="margin-top:0.7rem; background:var(--bg-tertiary); border:1px solid var(--accent-cyan); color:var(--accent-cyan); padding:0.4rem 0.8rem; border-radius:4px; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:0.3rem;">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"></path>
                            <circle cx="9" cy="9" r="2"></circle>
                            <circle cx="19" cy="5" r="2"></circle>
                          </svg>
                          T<sub>eq</sub> vs Radius Plot
                        </button>
                        <div id="teq-plot-container" style="display:none; margin-top:0.7rem;"></div>
                      `;
                    }

                    html += `
                        <a href="https://exoplanetarchive.ipac.caltech.edu/overview/${encodeURIComponent(hostname)}" target="_blank"
                           style="display:inline-block; margin-top:0.5rem; font-size:0.7rem; color:var(--accent-cyan);">
                          View on NASA Exoplanet Archive ‚Üí
                        </a>
                      </div>
                    </div>`;

                    container.innerHTML = html;
        }
        else {
          exoplanetData = null;
          container.innerHTML = `<div style="padding:0.5rem; font-size:0.85rem; color:var(--text-muted);">No confirmed exoplanets found in NASA Exoplanet Archive</div>`;
        }
      } catch (e) {
        console.error('Exoplanet Archive error:', e);
        container.innerHTML = `<div style="padding:0.5rem; color:var(--error); font-size:0.85rem;">Error checking exoplanet archive</div>`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg> Check Exoplanets`;
      }
    }

  // =========================
  // Main Search
  // =========================
  async function runSearch() {
    const input = document.getElementById('target-id').value;
    if (!input || !input.trim()) return;

    const btn = document.getElementById('search-btn');
    btn.disabled = true;

    startWalking();
    setStatus('Starting search‚Ä¶');
    updateProgress([
      { status: 'active', text: 'Resolve identifier (SIMBAD/Gaia)' },
      { status: 'pending', text: 'Fetch Gaia DR3 parameters' },
      { status: 'pending', text: 'Initialize sky view & plots' },
    ]);

    try {
      // 1) resolve identifier
      const resolved = await resolveIdentifier(input);
      if (!resolved?.gaiaId) throw new Error('Could not resolve identifier');

      updateProgress([
        { status: 'check', text: `Resolved: Gaia DR3 ${resolved.gaiaId}${resolved.resolvedName ? ' (SIMBAD: ' + resolved.resolvedName + ')' : ''}` },
        { status: 'active', text: 'Fetch Gaia DR3 parameters' },
        { status: 'pending', text: 'Initialize sky view & plots' },
      ]);

      // 2) fetch Gaia row
      const gaiaObj = await fetchTargetGaiaById(resolved.gaiaId);
      if (!gaiaObj) throw new Error('No Gaia DR3 record returned');

      gaiaObj._resolvedName = resolved.resolvedName || null;
      targetData = gaiaObj;

      // show results section
      document.getElementById('results-section').classList.add('visible');

      displayTargetInfo(targetData);
      displayExternalLinks(targetData, targetData._resolvedName);

      // 3) init sky + galactic map + toomre
      updateProgress([
        { status: 'check', text: `Resolved: Gaia DR3 ${resolved.gaiaId}${resolved.resolvedName ? ' (SIMBAD: ' + resolved.resolvedName + ')' : ''}` },
        { status: 'check', text: 'Fetched Gaia DR3 parameters' },
        { status: 'active', text: 'Initialize sky view & plots' },
      ]);

      initAladinViewer(targetData.ra, targetData.dec);
      displayGalacticMap(targetData.ra, targetData.dec);
      displayToomreDiagram(targetData);
      displayCMD([], targetData);  // Show CMD with just the target star initially

      updateProgress([
              { status: 'check', text: `Resolved: Gaia DR3 ${resolved.gaiaId}${resolved.resolvedName ? ' (SIMBAD: ' + resolved.resolvedName + ')' : ''}` },
              { status: 'check', text: 'Fetched Gaia DR3 parameters' },
              { status: 'check', text: 'Initialized sky view & plots' },
            ]);

      setStatus('Feel free to explore "Youth Indicators" or perform a "Comoving Search" on your target.', 'success');

      // clear previous comoving panel
      document.getElementById('comoving-panel').style.display = 'none';
      document.getElementById('tess-info-container').innerHTML = '';
      document.getElementById('exoplanet-alert').innerHTML = '';

      document.getElementById('li-values').innerHTML = '<div class="no-data">Click "Youth Indicators" above to search</div>';
      document.getElementById('rotation-results').innerHTML = '<div class="no-data">Click "Youth Indicators" above to search</div>';
      document.getElementById('rhk-results').innerHTML = '<div class="no-data">Click "Youth Indicators" above to search</div>';
      document.getElementById('lx-results').innerHTML = '<div class="no-data">Click "Youth Indicators" above to search</div>';
      document.getElementById('gyro-panel').style.display = 'none';
      vizierYouthData = { ewli: [], prot: [], rhk: [], lx: [] };
      ticInfo = null;

    } catch (e) {
      console.error(e);
      setStatus(`Error: ${e.message}`, 'error');
      updateProgress([]);
    } finally {
      stopWalking();
      btn.disabled = false;
    }
  }

  // Enter key triggers search
  document.getElementById('target-id').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') runSearch();
  });
</script>
</body>
</html>
