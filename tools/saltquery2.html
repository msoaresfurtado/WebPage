<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soares-Furtado Team Observation Query</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="site-badge">
                <a href="https://www.salt.ac.za/" target="_blank">Southern African Large Telescope (SALT)</a>
            </div>
            <h1>Soares-Furtado Team Observation Query</h1>
            <p class="subtitle">Search for SALT observations from the Ursa Major Spectral Survey</p>
        </header>

        <section class="search-section">
            <label class="search-label" for="gaia-id">Gaia DR3 Source ID</label>
            <div class="search-wrapper">
                <input type="text" id="gaia-id" class="search-input" placeholder="e.g., 4654969496256092032" autocomplete="off">
                <button class="search-btn" onclick="searchTarget()">Search</button>
            </div>
            <div class="search-links">
                <a href="#" onclick="showAllTargets(); return false;">Browse all targets</a>
                <span class="simbad-link" id="simbad-link">
                    · <a href="#" id="simbad-url" target="_blank">SIMBAD ↗</a>
                </span>
                <span class="vizier-link" id="vizier-link">
                    · <a href="#" id="vizier-url" target="_blank">VizieR ↗</a>
                </span>
            </div>
            
            <div class="recent-searches" id="recent-searches" style="display: none;">
                <div class="recent-searches-label">Recent searches</div>
                <div class="recent-tags" id="recent-tags"></div>
            </div>
        </section>

        <section id="results" class="results-section"></section>

        <div class="info-box">
            <strong>Data Access:</strong> Files are stored in the shared Dropbox folder 
            <code>SALT_data/2023-2-SCI-018/</code>. 
            Click "Copy Path" to get the file location, then navigate there in Finder.
            
            <div class="help-toggle" onclick="toggleHelp()">
                ⓘ Need help finding the files? Click here
            </div>
            
            <div class="help-content" id="help-content">
                <p><strong>Option 1: Shared Dropbox folder</strong></p>
                <p>If you have access to the shared Dropbox, make sure it's synced locally:</p>
                <ol>
                    <li>Open the <strong>Dropbox app</strong> on your Mac (not just the website)</li>
                    <li>In the Dropbox menu bar icon, click <strong>Preferences</strong> (gear icon)</li>
                    <li>Go to the <strong>Sync</strong> tab</li>
                    <li>Click <strong>Select folders to sync</strong></li>
                    <li>Make sure <code>Data/SALT_data/2023-2-SCI-018</code> is checked</li>
                    <li>Click <strong>Update</strong> and wait for sync to complete</li>
                </ol>
                <p style="margin-top: 0.75rem;">
                    Once synced, files will appear in <code>~/Dropbox/Data/SALT_data/2023-2-SCI-018/</code> on your Mac.
                </p>
                
                <p style="margin-top: 1rem;"><strong>Option 2: Local copies</strong></p>
                <p>If you downloaded the data to your own folder, the paths shown here are relative. 
                   Just use the night folder and product path (e.g., <code>231205/product/</code>) 
                   and navigate to that location within your local data directory.
                </p>
                <p style="margin-top: 0.5rem;">
                    For example, if your data lives in <code>/Users/jsheffler/Desktop/Salt_analysis/</code>, 
                    then <code>231205/product/</code> means <code>/Users/jsheffler/Desktop/Salt_analysis/231205/product/</code>.
                </p>
                
                <p style="margin-top: 1rem;">
                    Questions? Contact <a href="mailto:mmsoares@wisc.edu">mmsoares@wisc.edu</a>
                </p>
            </div>
        </div>
        
        <!-- Quality notes export section -->
        <div class="info-box" id="notes-export-box" style="display: none;">
            <strong>Your Quality Notes:</strong>
            <p style="margin-top: 0.5rem;">You have added quality notes. Click below to copy them for review.</p>
            <button class="export-btn" onclick="exportNotes()">Copy All Notes</button>
        </div>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="total-targets">0</div>
                <div class="stat-label">Targets</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-obs">0</div>
                <div class="stat-label">Observations</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-hq">0</div>
                <div class="stat-label">High Quality</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-nights">0</div>
                <div class="stat-label">Nights</div>
            </div>
        </div>
    </div>

    <!-- Quality Note Modal -->
    <div class="modal-overlay" id="note-modal" onclick="closeNoteModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Add Quality Note</h3>
            <p class="modal-subtitle" id="modal-obs-info"></p>
            
            <label class="modal-label">Your Name</label>
            <input type="text" id="note-author" class="modal-input" placeholder="e.g., Julia Sheffler">
            
            <label class="modal-label">Quality Assessment</label>
            <select id="note-quality" class="modal-select">
                <option value="Good">Good - Usable data</option>
                <option value="Poor">Poor - Quality issues</option>
                <option value="Unusable">Unusable - Should not use</option>
            </select>
            
            <label class="modal-label">Notes (optional)</label>
            <textarea id="note-text" class="modal-textarea" placeholder="Describe any issues you observed..."></textarea>
            
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeNoteModal()">Cancel</button>
                <button class="modal-btn save" onclick="saveQualityNote()">Save Note</button>
            </div>
        </div>
    </div>

    <script>
        const DROPBOX_FOLDER = '2023-2-SCI-018';
        const MAX_RECENT_SEARCHES = 4;
        let catalogData = null;
        let currentGaiaId = null;
        let currentNoteObsKey = null;
        
        // Cache for stellar data fetched from Gaia
        const stellarDataCache = {};

        // Spectral type lookup from Teff (approximate)
        function getSpectralType(teff) {
            if (!teff) return null;
            if (teff >= 30000) return 'O';
            if (teff >= 10000) return 'B';
            if (teff >= 7500) return 'A';
            if (teff >= 6000) return 'F';
            if (teff >= 5200) return 'G';
            if (teff >= 3700) return 'K';
            if (teff >= 2400) return 'M';
            return 'L';
        }

        // ============================================
        // Quality Notes (localStorage)
        // ============================================
        
        function getQualityNotes() {
            try {
                const stored = localStorage.getItem('saltQualityNotes');
                return stored ? JSON.parse(stored) : {};
            } catch {
                return {};
            }
        }
        
        function saveQualityNoteToStorage(obsKey, note) {
            try {
                const notes = getQualityNotes();
                notes[obsKey] = note;
                localStorage.setItem('saltQualityNotes', JSON.stringify(notes));
                updateNotesExportBox();
            } catch {
                console.error('Could not save note');
            }
        }
        
        function getObsKey(gaiaId, date) {
            return `${gaiaId}_${date}`;
        }
        
        function updateNotesExportBox() {
            const notes = getQualityNotes();
            const box = document.getElementById('notes-export-box');
            if (Object.keys(notes).length > 0) {
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
            }
        }
        
        function exportNotes() {
            const notes = getQualityNotes();
            let exportText = "SALT Quality Notes Export\n";
            exportText += "========================\n\n";
            
            for (const [key, note] of Object.entries(notes)) {
                const [gaiaId, date] = key.split('_');
                exportText += `Gaia DR3 ${gaiaId}\n`;
                exportText += `Date: ${date}\n`;
                exportText += `Reviewer: ${note.author}\n`;
                exportText += `Assessment: ${note.quality}\n`;
                if (note.text) {
                    exportText += `Notes: ${note.text}\n`;
                }
                exportText += `Reviewed: ${note.timestamp}\n`;
                exportText += "\n---\n\n";
            }
            
            navigator.clipboard.writeText(exportText).then(() => {
                alert('Notes copied to clipboard! You can paste them in an email to mmsoares@wisc.edu');
            });
        }
        
        function openNoteModal(gaiaId, date, obsInfo) {
            currentNoteObsKey = getObsKey(gaiaId, date);
            document.getElementById('modal-obs-info').textContent = `Gaia DR3 ${gaiaId} — ${date}`;
            
            const notes = getQualityNotes();
            const existing = notes[currentNoteObsKey];
            if (existing) {
                document.getElementById('note-author').value = existing.author || '';
                document.getElementById('note-quality').value = existing.quality || 'Good';
                document.getElementById('note-text').value = existing.text || '';
            } else {
                document.getElementById('note-author').value = localStorage.getItem('saltUserName') || '';
                document.getElementById('note-quality').value = 'Good';
                document.getElementById('note-text').value = '';
            }
            
            document.getElementById('note-modal').classList.add('visible');
        }
        
        function closeNoteModal(event) {
            if (event && event.target !== document.getElementById('note-modal')) return;
            document.getElementById('note-modal').classList.remove('visible');
            currentNoteObsKey = null;
        }
        
        function saveQualityNote() {
            const author = document.getElementById('note-author').value.trim();
            const quality = document.getElementById('note-quality').value;
            const text = document.getElementById('note-text').value.trim();
            
            if (!author) {
                alert('Please enter your name');
                return;
            }
            
            localStorage.setItem('saltUserName', author);
            
            const note = {
                author: author,
                quality: quality,
                text: text,
                timestamp: new Date().toISOString().split('T')[0]
            };
            
            saveQualityNoteToStorage(currentNoteObsKey, note);
            closeNoteModal();
            
            // Update high-quality count
            updateHQCount();
            
            if (currentGaiaId) {
                const target = catalogData.targets.find(t => t.gaia_dr3_id === currentGaiaId);
                if (target) displayResults(target);
            }
        }
        
        function updateHQCount() {
            if (!catalogData) return;
            const qualityNotes = getQualityNotes();
            let hqCount = 0;
            catalogData.targets.forEach(t => {
                t.observations.forEach(obs => {
                    const obsKey = getObsKey(t.gaia_dr3_id, obs.date);
                    const userNote = qualityNotes[obsKey];
                    const catalogStatus = obs.quality_status || 'Accepted';
                    if (catalogStatus === 'Accepted') {
                        if (!userNote || userNote.quality === 'Good') {
                            hqCount++;
                        }
                    }
                });
            });
            document.getElementById('total-hq').textContent = hqCount;
        }

        // ============================================
        // Recent searches (localStorage)
        // ============================================
        
        function getRecentSearches() {
            try {
                const stored = localStorage.getItem('saltRecentSearches');
                return stored ? JSON.parse(stored) : [];
            } catch {
                return [];
            }
        }

        function saveRecentSearch(gaiaId) {
            try {
                let recent = getRecentSearches();
                recent = recent.filter(id => id !== gaiaId);
                recent.unshift(gaiaId);
                recent = recent.slice(0, MAX_RECENT_SEARCHES);
                localStorage.setItem('saltRecentSearches', JSON.stringify(recent));
                renderRecentSearches();
            } catch {}
        }

        function renderRecentSearches() {
            const recent = getRecentSearches();
            const container = document.getElementById('recent-searches');
            const tagsContainer = document.getElementById('recent-tags');
            
            if (recent.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            tagsContainer.innerHTML = recent.map(id => 
                `<span class="recent-tag" onclick="selectTarget('${id}')">${id}</span>`
            ).join('');
        }

        // ============================================
        // External links
        // ============================================
        
        function showExternalLinks(gaiaId) {
            // SIMBAD
            const simbadContainer = document.getElementById('simbad-link');
            const simbadUrl = document.getElementById('simbad-url');
            simbadUrl.href = `https://simbad.u-strasbg.fr/simbad/sim-id?Ident=Gaia+DR3+${gaiaId}`;
            simbadContainer.classList.add('visible');
            
            // VizieR - all catalogs
            const vizierContainer = document.getElementById('vizier-link');
            const vizierUrl = document.getElementById('vizier-url');
            vizierUrl.href = `https://vizier.cds.unistra.fr/viz-bin/VizieR-4?-source=&-out.all&-c=Gaia+DR3+${gaiaId}&-c.rs=2`;
            vizierContainer.classList.add('visible');
        }

        function hideExternalLinks() {
            document.getElementById('simbad-link').classList.remove('visible');
            document.getElementById('vizier-link').classList.remove('visible');
        }
        
        // ============================================
        // Stellar data fetching from Gaia archive
        // ============================================
        
// ============================================
// Stellar data fetching from VizieR (CORS-enabled)
// ============================================
async function fetchStellarData(gaiaId) {
  if (stellarDataCache[gaiaId] !== undefined) {
    return stellarDataCache[gaiaId];
  }
  
  try {
    const url = 'https://tapvizier.cds.unistra.fr/TAPVizieR/tap/sync';
    
    // Query using VizieR catalog identifiers instead of ESA's
    const query = `
      SELECT "Source", "Gmag", "BPmag", "RPmag", "Plx", "e_Plx", "Teff", "RV", "e_RV", "RUWE"
      FROM "I/355/gaiadr3"
      WHERE "Source" = '${gaiaId}'
    `;
    
    const params = new URLSearchParams({
      REQUEST: 'doQuery',
      LANG: 'ADQL',
      FORMAT: 'json',
      QUERY: query.replace(/\\s+/g, ' ').trim()
    });
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params
    });
    
    if (!response.ok) throw new Error('VizieR query failed');
    
    const data = await response.json();
    
    if (data.data && data.data.length > 0) {
      const row = data.data[0];
      const result = {
        source_id: String(row[0]),
        g_mag: row[1],
        bp_mag: row[2],
        rp_mag: row[3],
        parallax: row[4],
        parallax_error: row[5],
        teff: row[6],
        rv: row[7],
        rv_error: row[8],
        ruwe: row[9],
        // Derived values
        bp_rp: (row[2] && row[3]) ? row[2] - row[3] : null,
        distance: row[4] > 0 ? 1000 / row[4] : null, // pc
        abs_g: (row[1] && row[4] > 0) ? row[1] - 5 * Math.log10(1000 / row[4]) + 5 : null
      };
      stellarDataCache[gaiaId] = result;
      return result;
    }
  } catch (error) {
    console.warn('Could not fetch stellar data from VizieR:', error);
  }
  
  stellarDataCache[gaiaId] = null;
  return null;
}
        // ============================================
        // CMD Drawing
        // ============================================
        
        function drawCMD(canvas, stellarData) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear
            ctx.fillStyle = '#1e2022';
            ctx.fillRect(0, 0, width, height);
            
            // CMD bounds (typical for nearby stars)
            const bpRpMin = -0.5, bpRpMax = 4.0;
            const magMin = -2, magMax = 14;
            
            // Padding
            const pad = { left: 45, right: 15, top: 15, bottom: 35 };
            const plotWidth = width - pad.left - pad.right;
            const plotHeight = height - pad.top - pad.bottom;
            
            // Scale functions
            const xScale = (bpRp) => pad.left + ((bpRp - bpRpMin) / (bpRpMax - bpRpMin)) * plotWidth;
            const yScale = (mag) => pad.top + ((mag - magMin) / (magMax - magMin)) * plotHeight;
            
            // Draw grid
            ctx.strokeStyle = '#333638';
            ctx.lineWidth = 1;
            
            // Vertical grid lines
            for (let bp = 0; bp <= 4; bp++) {
                const x = xScale(bp);
                ctx.beginPath();
                ctx.moveTo(x, pad.top);
                ctx.lineTo(x, height - pad.bottom);
                ctx.stroke();
            }
            
            // Horizontal grid lines
            for (let m = 0; m <= 12; m += 2) {
                const y = yScale(m);
                ctx.beginPath();
                ctx.moveTo(pad.left, y);
                ctx.lineTo(width - pad.right, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#7d7873';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(pad.left, pad.top);
            ctx.lineTo(pad.left, height - pad.bottom);
            ctx.lineTo(width - pad.right, height - pad.bottom);
            ctx.stroke();
            
            // Axis labels
            ctx.fillStyle = '#b8b2ad';
            ctx.font = '11px "DM Sans", sans-serif';
            ctx.textAlign = 'center';
            
            // X axis label
            ctx.fillText('BP − RP', width / 2, height - 5);
            
            // X axis ticks
            ctx.font = '9px "DM Mono", monospace';
            for (let bp = 0; bp <= 4; bp++) {
                ctx.fillText(bp.toString(), xScale(bp), height - pad.bottom + 15);
            }
            
            // Y axis label
            ctx.save();
            ctx.translate(12, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.font = '11px "DM Sans", sans-serif';
            ctx.fillText('Mɢ', 0, 0);
            ctx.restore();
            
            // Y axis ticks
            ctx.textAlign = 'right';
            ctx.font = '9px "DM Mono", monospace';
            for (let m = 0; m <= 12; m += 2) {
                ctx.fillText(m.toString(), pad.left - 5, yScale(m) + 3);
            }
            
            // Draw approximate main sequence (for reference)
            ctx.strokeStyle = 'rgba(232, 165, 152, 0.2)';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(xScale(-0.3), yScale(-1));
            ctx.bezierCurveTo(
                xScale(0.5), yScale(2),
                xScale(1.5), yScale(6),
                xScale(3.5), yScale(12)
            );
            ctx.stroke();
            
            // Plot the star if we have data
            if (stellarData && stellarData.bp_rp !== null && stellarData.abs_g !== null) {
                const x = xScale(stellarData.bp_rp);
                const y = yScale(stellarData.abs_g);
                
                // Check if in bounds
                if (x >= pad.left && x <= width - pad.right && y >= pad.top && y <= height - pad.bottom) {
                    // Glow effect
                    const gradient = ctx.createRadialGradient(x, y, 0, x, y, 12);
                    gradient.addColorStop(0, 'rgba(232, 165, 152, 0.8)');
                    gradient.addColorStop(0.5, 'rgba(232, 165, 152, 0.3)');
                    gradient.addColorStop(1, 'rgba(232, 165, 152, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(x, y, 12, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Star point
                    ctx.fillStyle = '#e8a598';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // White center
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(x, y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        // ============================================
        // Help toggle
        // ============================================
        
        function toggleHelp() {
            document.getElementById('help-content').classList.toggle('visible');
        }

        // ============================================
        // Catalog loading
        // ============================================
        
        async function loadCatalog() {
            try {
                const response = await fetch('./index.json');
                if (!response.ok) throw new Error('Catalog not found');
                catalogData = await response.json();
                
                document.getElementById('total-targets').textContent = catalogData.targets.length;
                const totalObs = catalogData.targets.reduce((sum, t) => sum + t.observations.length, 0);
                document.getElementById('total-obs').textContent = totalObs;
                
                // Calculate high-quality observations
                const qualityNotes = getQualityNotes();
                let hqCount = 0;
                catalogData.targets.forEach(t => {
                    t.observations.forEach(obs => {
                        const obsKey = getObsKey(t.gaia_dr3_id, obs.date);
                        const userNote = qualityNotes[obsKey];
                        const catalogStatus = obs.quality_status || 'Accepted';
                        
                        // High quality if: catalog says Accepted AND (no user note OR user says Good)
                        if (catalogStatus === 'Accepted') {
                            if (!userNote || userNote.quality === 'Good') {
                                hqCount++;
                            }
                        }
                    });
                });
                document.getElementById('total-hq').textContent = hqCount;
                
                const nights = new Set();
                catalogData.targets.forEach(t => t.observations.forEach(o => nights.add(o.date)));
                document.getElementById('total-nights').textContent = nights.size;
                
                renderRecentSearches();
                updateNotesExportBox();
            } catch (error) {
                console.error('Error loading catalog:', error);
                showStatus('Unable to load observation catalog.', true);
            }
        }

        // ============================================
        // Search
        // ============================================
        
        function searchTarget() {
            const gaiaId = document.getElementById('gaia-id').value.trim();
            if (!gaiaId) { 
                showStatus('Please enter a Gaia DR3 source ID.', true); 
                hideExternalLinks();
                return; 
            }
            if (!catalogData) { 
                showStatus('Catalog not loaded. Please refresh.', true); 
                return; 
            }

            const target = catalogData.targets.find(t => t.gaia_dr3_id === gaiaId);
            if (!target) { 
                showStatus(`No observations found for Gaia DR3 ${gaiaId}`, true); 
                hideExternalLinks();
                return; 
            }

            currentGaiaId = gaiaId;
            saveRecentSearch(gaiaId);
            showExternalLinks(gaiaId);
            displayResults(target);
        }

        // ============================================
        // DQM Pass Count
        // ============================================
        
        function getDQMPassCount(target) {
            const qualityNotes = getQualityNotes();
            let passCount = 0;
            
            for (const obs of target.observations) {
                const obsKey = getObsKey(target.gaia_dr3_id, obs.date);
                const userNote = qualityNotes[obsKey];
                const catalogStatus = obs.quality_status || 'Accepted';
                
                // Pass if: catalog says Accepted AND (no user note OR user says Good)
                if (catalogStatus === 'Accepted') {
                    if (!userNote || userNote.quality === 'Good') {
                        passCount++;
                    }
                }
            }
            
            return passCount;
        }

        // ============================================
        // Display results
        // ============================================
        
        async function displayResults(target) {
            const resultsSection = document.getElementById('results');
            const qualityNotes = getQualityNotes();
            const dqmPassCount = getDQMPassCount(target);
            
            const obsHtml = target.observations.map((obs, idx) => {
                const allFiles = obs.all_files || [obs.filename];
                const mainFile = obs.filename;
                const dropboxPath = obs.dropbox_path || '';
                const fullPath = `${DROPBOX_FOLDER}/${dropboxPath}`;
                const obsKey = getObsKey(target.gaia_dr3_id, obs.date);
                const userNote = qualityNotes[obsKey];
                
                let qualityHtml = '';
                const catalogStatus = obs.quality_status || 'Accepted';
                const catalogReason = obs.quality_reason;
                
                if (catalogStatus === 'Rejected') {
                    qualityHtml = `<span class="quality-badge rejected">Rejected${catalogReason ? `: ${catalogReason}` : ''}</span>`;
                } else if (userNote) {
                    const noteClass = userNote.quality === 'Good' ? 'good' : (userNote.quality === 'Poor' ? 'poor' : 'unusable');
                    qualityHtml = `<span class="quality-badge ${noteClass}">${userNote.quality} (${userNote.author})</span>`;
                } else {
                    qualityHtml = `<span class="quality-badge accepted">Accepted</span>`;
                }
                
                const conditionsHtml = obs.conditions ? 
                    `<div class="obs-conditions">☁ ${obs.conditions}${obs.seeing ? ` · Seeing: ${obs.seeing}"` : ''}</div>` : 
                    (obs.seeing ? `<div class="obs-conditions">Seeing: ${obs.seeing}"</div>` : '');
                
                return `
                    <div class="obs-item">
                        <div class="obs-header" onclick="toggleFiles(${idx})">
                            <div class="obs-info">
                                <div class="obs-date">${obs.date} ${qualityHtml}</div>
                                <div class="obs-details">
                                    ${obs.instrument} · ${obs.mode || 'Standard'} · ${obs.exposure_time}s · ${allFiles.length} files
                                </div>
                                ${conditionsHtml}
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="obs-files" id="files-${idx}">
                            <div class="dropbox-path">
                                <code>${fullPath}/</code>
                                <button class="copy-btn" onclick="copyPath('${fullPath}/', this); event.stopPropagation();">Copy Path</button>
                            </div>
                            <div class="files-grid">
                                ${allFiles.map(f => {
                                    const isMain = f === mainFile;
                                    const badge = getFileBadge(f);
                                    return `<div class="file-item">${badge ? `<span class="file-badge ${isMain ? 'main' : ''}">${badge}</span>` : ''}<span>${f}</span></div>`;
                                }).join('')}
                            </div>
                            <div class="note-section">
                                ${userNote ? `
                                    <div class="user-note">
                                        <strong>${userNote.author}</strong> marked as <strong>${userNote.quality}</strong> on ${userNote.timestamp}
                                        ${userNote.text ? `<br><em>"${userNote.text}"</em>` : ''}
                                    </div>
                                ` : ''}
                                <button class="add-note-btn" onclick="openNoteModal('${target.gaia_dr3_id}', '${obs.date}'); event.stopPropagation();">
                                    ${userNote ? '✎ Edit Note' : '+ Add Quality Note'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsSection.innerHTML = `
                <div class="result-card">
                    <div class="result-header">
                        <div class="target-name">Gaia DR3 ${target.gaia_dr3_id}</div>
                        <div class="coords">
                            RA: ${target.ra_deg?.toFixed(6) || 'N/A'}° · Dec: ${target.dec_deg?.toFixed(6) || 'N/A'}°
                            ${target.common_name ? ` · ${target.common_name}` : ''}
                        </div>
                    </div>
                    <div class="result-body">
                        <div class="stellar-section">
                            <div class="cmd-container">
                                <canvas id="cmd-canvas" width="280" height="260"></canvas>
                            </div>
                            <div class="stellar-params" id="stellar-params">
                                <div class="param-row">
                                    <span class="param-label">G mag</span>
                                    <span class="param-value" id="param-gmag">Loading...</span>
                                </div>
                                <div class="param-row">
                                    <span class="param-label">BP − RP</span>
                                    <span class="param-value" id="param-bprp">Loading...</span>
                                </div>
                                <div class="param-row">
                                    <span class="param-label">Distance</span>
                                    <span class="param-value" id="param-dist">Loading...</span>
                                </div>
                                <div class="param-row">
                                    <span class="param-label">Spectral Type</span>
                                    <span class="param-value" id="param-sptype">Loading...</span>
                                </div>
                                <div class="param-row">
                                    <span class="param-label">Teff</span>
                                    <span class="param-value" id="param-teff">Loading...</span>
                                </div>
                                <div class="param-row">
                                    <span class="param-label">Radial Velocity</span>
                                    <span class="param-value" id="param-rv">Loading...</span>
                                </div>
                                <div class="param-row">
                                    <span class="param-label">RUWE</span>
                                    <span class="param-value" id="param-ruwe">Loading...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="meta-grid">
                            <div class="meta-item">
                                <div class="meta-label">Observations</div>
                                <div class="meta-value">${target.observations.length}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">DQM Pass</div>
                                <div class="meta-value">${dqmPassCount} / ${target.observations.length}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Program</div>
                                <div class="meta-value">${target.program || 'General'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Notes</div>
                                <div class="meta-value">${target.notes || 'None'}</div>
                            </div>
                        </div>
                        <div class="observations-header">Observations</div>
                        ${obsHtml}
                    </div>
                </div>
            `;
            resultsSection.classList.add('visible');
            
            // Fetch stellar data and update display
            const stellarData = await fetchStellarData(target.gaia_dr3_id);
            updateStellarDisplay(stellarData);
        }
        
        function updateStellarDisplay(data) {
            const canvas = document.getElementById('cmd-canvas');
            if (canvas) {
                drawCMD(canvas, data);
            }
            
            if (data) {
                document.getElementById('param-gmag').textContent = data.g_mag?.toFixed(2) || 'N/A';
                document.getElementById('param-bprp').textContent = data.bp_rp?.toFixed(2) || 'N/A';
                document.getElementById('param-dist').textContent = data.distance ? `${data.distance.toFixed(1)} pc` : 'N/A';
                document.getElementById('param-sptype').textContent = getSpectralType(data.teff) || 'N/A';
                document.getElementById('param-teff').textContent = data.teff ? `${Math.round(data.teff)} K` : 'N/A';
                document.getElementById('param-rv').textContent = data.rv ? `${data.rv.toFixed(1)} ± ${data.rv_error?.toFixed(1) || '?'} km/s` : 'N/A';
                document.getElementById('param-ruwe').textContent = data.ruwe?.toFixed(2) || 'N/A';
            } else {
                document.querySelectorAll('.param-value').forEach(el => el.textContent = 'N/A');
            }
        }

        // ============================================
        // All targets view
        // ============================================
        
        function showAllTargets() {
            if (!catalogData) return;
            hideExternalLinks();
            currentGaiaId = null;
            
            const resultsSection = document.getElementById('results');
            const sortedTargets = [...catalogData.targets].sort((a, b) => 
                b.observations.length - a.observations.length
            );
            
            resultsSection.innerHTML = `
                <div class="all-targets">
                    <h2>All Targets (${catalogData.targets.length})</h2>
                    <div class="target-list">
                        ${sortedTargets.map(t => `
                            <div class="target-item" onclick="selectTarget('${t.gaia_dr3_id}')">
                                <div class="gaia-id">${t.gaia_dr3_id}</div>
                                <div class="obs-count">${t.observations.length} obs</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            resultsSection.classList.add('visible');
        }

        function selectTarget(gaiaId) {
            document.getElementById('gaia-id').value = gaiaId;
            searchTarget();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // Utilities
        // ============================================
        
        function toggleFiles(idx) {
            const filesDiv = document.getElementById(`files-${idx}`);
            const header = filesDiv.previousElementSibling;
            filesDiv.classList.toggle('expanded');
            header.classList.toggle('expanded');
        }

        function copyPath(path, btn) {
            navigator.clipboard.writeText(path).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => { 
                    btn.textContent = 'Copy Path'; 
                    btn.classList.remove('copied'); 
                }, 2000);
            });
        }

        function getFileBadge(filename) {
            if (filename.includes('_uwm')) return 'merged';
            if (filename.includes('_1wm') || filename.includes('_2wm')) return 'merged';
            if (filename.includes('_1we') || filename.includes('_2we')) return 'extracted';
            if (filename.includes('_1w.') || filename.includes('_2w.')) return 'wavelength';
            if (filename.includes('SNR')) return 'SNR';
            return null;
        }

        function showStatus(message, isError = false) {
            const resultsSection = document.getElementById('results');
            resultsSection.innerHTML = `<div class="status ${isError ? 'error' : ''}"><p>${message}</p></div>`;
            resultsSection.classList.add('visible');
        }

        // ============================================
        // Init
        // ============================================
        
        document.getElementById('gaia-id').addEventListener('keypress', e => { 
            if (e.key === 'Enter') searchTarget(); 
        });
        
        loadCatalog();
    </script>
</body>
</html>
